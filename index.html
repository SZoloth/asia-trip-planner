<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Asia Trip 2025 | Sam & Carter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                        },
                        thailand: { bg: '#fef3c7', text: '#92400e', border: '#f59e0b' },
                        cambodia: { bg: '#fee2e2', text: '#991b1b', border: '#ef4444' },
                        taiwan: { bg: '#d1fae5', text: '#065f46', border: '#10b981' },
                    }
                }
            }
        }
    </script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Plus Jakarta Sans', system-ui, sans-serif; }

        /* Smooth scrolling */
        html { scroll-behavior: smooth; }

        /* Custom scrollbar */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .scrollbar-thin::-webkit-scrollbar { width: 4px; height: 4px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }

        /* Glass morphism */
        .glass { background: rgba(255,255,255,0.8); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        .glass-dark { background: rgba(0,0,0,0.6); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }

        /* Card styles */
        .card { background: white; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 4px 12px rgba(0,0,0,0.04); transition: all 0.2s ease; }
        .card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.08), 0 8px 24px rgba(0,0,0,0.06); }
        .card-interactive { cursor: pointer; }
        .card-interactive:active { transform: scale(0.98); }

        /* Destination card drag states */
        .dest-card { cursor: grab; transition: all 0.15s ease; }
        .dest-card:active { cursor: grabbing; }
        .dest-card.dragging { opacity: 0.4; transform: scale(0.95); }

        /* Day slot states */
        .day-slot { transition: all 0.15s ease; }
        .day-slot.drag-over { background: linear-gradient(135deg, #dbeafe 0%, #ede9fe 100%); border-color: #818cf8; transform: scale(1.02); }
        .day-slot-empty { border: 2px dashed #e2e8f0; }
        .day-slot-filled { border: 2px solid #e2e8f0; background: white; }

        /* Country badges */
        .badge-thailand { background: linear-gradient(135deg, #fef3c7, #fde68a); color: #92400e; }
        .badge-cambodia { background: linear-gradient(135deg, #fee2e2, #fecaca); color: #991b1b; }
        .badge-taiwan { background: linear-gradient(135deg, #d1fae5, #a7f3d0); color: #065f46; }
        .badge-custom { background: linear-gradient(135deg, #e0e7ff, #c7d2fe); color: #4338ca; }

        /* Country accents */
        .accent-thailand { border-left: 3px solid #f59e0b; }
        .accent-cambodia { border-left: 3px solid #ef4444; }
        .accent-taiwan { border-left: 3px solid #10b981; }
        .accent-custom { border-left: 3px solid #6366f1; }

        /* Custom item badge */
        .custom-badge {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            color: white; font-size: 10px; font-weight: 700; padding: 4px 8px;
            border-radius: 6px; text-transform: uppercase; letter-spacing: 0.5px;
        }

        /* Closed destination styling */
        .dest-closed { position: relative; opacity: 0.5; }
        .dest-closed::after {
            content: ''; position: absolute; inset: 0;
            background: repeating-linear-gradient(45deg, transparent, transparent 8px, rgba(239,68,68,0.08) 8px, rgba(239,68,68,0.08) 16px);
            border-radius: inherit; pointer-events: none;
        }

        /* NYE highlight */
        .nye-glow {
            background: linear-gradient(135deg, #faf5ff, #fdf4ff);
            border: 2px solid #c084fc;
            animation: nye-pulse 3s ease-in-out infinite;
        }
        @keyframes nye-pulse {
            0%, 100% { border-color: #c084fc; box-shadow: 0 0 0 0 rgba(192,132,252,0.4); }
            50% { border-color: #a855f7; box-shadow: 0 0 16px 2px rgba(192,132,252,0.2); }
        }

        /* Tab indicators */
        .tab-active { color: #0ea5e9; }
        .tab-active::after {
            content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 24px; height: 3px; background: #0ea5e9; border-radius: 3px 3px 0 0;
        }

        /* Button styles */
        .btn-primary {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            color: white; font-weight: 600; padding: 10px 20px; border-radius: 12px;
            transition: all 0.15s ease; box-shadow: 0 2px 8px rgba(14,165,233,0.3);
        }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(14,165,233,0.4); }
        .btn-primary:active { transform: translateY(0); }

        .btn-secondary {
            background: #f1f5f9; color: #475569; font-weight: 500; padding: 10px 20px; border-radius: 12px;
            transition: all 0.15s ease;
        }
        .btn-secondary:hover { background: #e2e8f0; }

        /* Highlight badge */
        .highlight-badge {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white; font-size: 10px; font-weight: 700; padding: 4px 8px;
            border-radius: 6px; text-transform: uppercase; letter-spacing: 0.5px;
        }

        .closed-badge {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white; font-size: 10px; font-weight: 700; padding: 4px 8px;
            border-radius: 6px; text-transform: uppercase; letter-spacing: 0.5px;
        }

        /* Progress bar */
        .progress-ring { transform: rotate(-90deg); }

        /* Mobile bottom nav */
        @media (max-width: 768px) {
            .bottom-nav { padding-bottom: env(safe-area-inset-bottom); }
        }

        /* Animations */
        .fade-in { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        .slide-up { animation: slideUp 0.4s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(100%); } to { opacity: 1; transform: translateY(0); } }

        /* Empty state */
        .empty-state {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border: 2px dashed #e2e8f0; border-radius: 12px;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-20 md:pb-0">
    <!-- Header -->
    <header class="bg-white border-b border-slate-100 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-sky-400 to-violet-500 flex items-center justify-center text-white">
                        <i class="fas fa-plane text-sm"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-slate-800">Asia 2025</h1>
                        <p class="text-xs text-slate-500">Sam & Carter</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="hidden sm:flex items-center gap-2 text-sm bg-slate-100 rounded-full px-4 py-2">
                        <i class="fas fa-calendar-alt text-slate-400"></i>
                        <span class="font-medium text-slate-700">Dec 28 - Jan 16</span>
                    </div>
                    <div class="flex items-center gap-2 bg-emerald-50 rounded-full px-4 py-2">
                        <span class="text-sm font-semibold text-emerald-700" id="budget-header">$0</span>
                    </div>
                    <!-- Collaboration Status -->
                    <div id="collab-status" class="hidden flex items-center gap-2 bg-purple-50 rounded-full px-4 py-2 cursor-pointer hover:bg-purple-100 transition-colors" onclick="showCollabModal()">
                        <span class="w-2 h-2 rounded-full bg-purple-500 animate-pulse"></span>
                        <span class="text-sm font-medium text-purple-700" id="collab-room-code">Room: ------</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Desktop Navigation -->
        <nav class="hidden md:block border-t border-slate-100">
            <div class="max-w-6xl mx-auto px-4">
                <div class="flex gap-1">
                    <button onclick="showTab('planner')" id="tab-planner" class="relative px-5 py-3 font-medium text-sm tab-active transition-colors">
                        <i class="fas fa-map-marked-alt mr-2"></i>Planner
                    </button>
                    <button onclick="showTab('destinations')" id="tab-destinations" class="relative px-5 py-3 font-medium text-sm text-slate-500 hover:text-slate-700 transition-colors">
                        <i class="fas fa-compass mr-2"></i>Explore
                    </button>
                    <button onclick="showTab('decisions')" id="tab-decisions" class="relative px-5 py-3 font-medium text-sm text-slate-500 hover:text-slate-700 transition-colors">
                        <i class="fas fa-lightbulb mr-2"></i>Decisions
                    </button>
                    <button onclick="showTab('logistics')" id="tab-logistics" class="relative px-5 py-3 font-medium text-sm text-slate-500 hover:text-slate-700 transition-colors">
                        <i class="fas fa-info-circle mr-2"></i>Info
                    </button>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto px-4 py-6">
        <!-- Planner Tab -->
        <div id="content-planner" class="fade-in">
            <!-- Quick Templates -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-sm font-semibold text-slate-500 uppercase tracking-wide">Quick Start</h2>
                    <button onclick="clearItinerary()" class="text-sm text-slate-400 hover:text-red-500 transition-colors">
                        <i class="fas fa-eraser mr-1"></i>Clear all
                    </button>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button onclick="loadTemplate('thailand')" class="inline-flex items-center gap-2 px-4 py-2.5 rounded-xl bg-amber-50 hover:bg-amber-100 text-amber-700 font-medium text-sm transition-colors">
                        <span class="w-2 h-2 rounded-full bg-amber-500"></span>
                        Thailand Only
                    </button>
                    <button onclick="loadTemplate('thailand-cambodia')" class="inline-flex items-center gap-2 px-4 py-2.5 rounded-xl bg-rose-50 hover:bg-rose-100 text-rose-700 font-medium text-sm transition-colors">
                        <span class="w-2 h-2 rounded-full bg-rose-500"></span>
                        + Cambodia
                    </button>
                    <button onclick="loadTemplate('all')" class="inline-flex items-center gap-2 px-4 py-2.5 rounded-xl bg-emerald-50 hover:bg-emerald-100 text-emerald-700 font-medium text-sm transition-colors">
                        <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
                        All Three
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <!-- Sidebar - Destinations -->
                <div class="lg:col-span-3">
                    <div class="card p-4 sticky top-32">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-slate-800">Destinations</h3>
                            <span class="text-xs text-slate-400" id="dest-count">0 places</span>
                        </div>

                        <!-- Add Custom Button -->
                        <button onclick="showCreateCustomModal()" class="w-full mb-4 flex items-center justify-center gap-2 px-4 py-2.5 rounded-xl bg-indigo-50 hover:bg-indigo-100 text-indigo-700 font-medium text-sm transition-colors border-2 border-dashed border-indigo-200 hover:border-indigo-300">
                            <i class="fas fa-plus"></i>
                            Add Custom Activity
                        </button>

                        <div class="relative mb-4">
                            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm"></i>
                            <input type="text" id="destination-search" placeholder="Search..."
                                   class="w-full pl-9 pr-4 py-2.5 bg-slate-50 border-0 rounded-xl text-sm focus:ring-2 focus:ring-sky-500 focus:bg-white transition-all"
                                   oninput="filterDestinations(this.value)">
                        </div>

                        <div class="space-y-4 max-h-[calc(100vh-320px)] overflow-y-auto scrollbar-thin pr-1" id="destination-list">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Calendar Grid -->
                <div class="lg:col-span-9">
                    <div class="card p-5 mb-6">
                        <div class="flex items-center justify-between mb-5">
                            <div>
                                <h3 class="font-semibold text-slate-800">Your 20-Day Journey</h3>
                                <p class="text-sm text-slate-500 mt-0.5">Drag destinations to plan each day</p>
                            </div>
                            <div class="flex items-center gap-2 text-xs">
                                <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-amber-400"></span>Thailand</span>
                                <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-rose-400"></span>Cambodia</span>
                                <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-emerald-400"></span>Taiwan</span>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 sm:grid-cols-4 xl:grid-cols-5 gap-3" id="calendar-grid">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Budget Summary -->
                    <div class="card p-5">
                        <h3 class="font-semibold text-slate-800 mb-4">
                            <i class="fas fa-chart-pie mr-2 text-sky-500"></i>Budget Estimate
                        </h3>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                            <div class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-2xl p-4 text-center">
                                <div class="text-2xl font-bold text-amber-600" id="budget-thailand">$0</div>
                                <div class="text-xs text-amber-600/70 font-medium mt-1">Thailand</div>
                            </div>
                            <div class="bg-gradient-to-br from-rose-50 to-pink-50 rounded-2xl p-4 text-center">
                                <div class="text-2xl font-bold text-rose-600" id="budget-cambodia">$0</div>
                                <div class="text-xs text-rose-600/70 font-medium mt-1">Cambodia</div>
                            </div>
                            <div class="bg-gradient-to-br from-emerald-50 to-teal-50 rounded-2xl p-4 text-center">
                                <div class="text-2xl font-bold text-emerald-600" id="budget-taiwan">$0</div>
                                <div class="text-xs text-emerald-600/70 font-medium mt-1">Taiwan</div>
                            </div>
                            <div class="bg-gradient-to-br from-sky-50 to-indigo-50 rounded-2xl p-4 text-center">
                                <div class="text-2xl font-bold text-sky-600" id="budget-total">$0</div>
                                <div class="text-xs text-sky-600/70 font-medium mt-1">Total</div>
                            </div>
                        </div>
                        <p class="text-xs text-slate-400 mt-4 text-center">Based on mid-range daily costs: Thailand $110, Cambodia $100, Taiwan $150</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Destinations Tab -->
        <div id="content-destinations" class="hidden fade-in">
            <!-- Filters -->
            <div class="space-y-3 mb-6">
                <!-- Country + Search Row -->
                <div class="flex flex-wrap items-center gap-3">
                    <div class="flex bg-white rounded-xl p-1 shadow-sm">
                        <button onclick="filterByCountry('all')" class="country-filter px-4 py-2 rounded-lg text-sm font-medium bg-slate-100 text-slate-700" data-country="all">All</button>
                        <button onclick="filterByCountry('thailand')" class="country-filter px-4 py-2 rounded-lg text-sm font-medium text-slate-500 hover:bg-slate-50" data-country="thailand">Thailand</button>
                        <button onclick="filterByCountry('cambodia')" class="country-filter px-4 py-2 rounded-lg text-sm font-medium text-slate-500 hover:bg-slate-50" data-country="cambodia">Cambodia</button>
                        <button onclick="filterByCountry('taiwan')" class="country-filter px-4 py-2 rounded-lg text-sm font-medium text-slate-500 hover:bg-slate-50" data-country="taiwan">Taiwan</button>
                        <button onclick="filterByCountry('custom')" class="country-filter px-4 py-2 rounded-lg text-sm font-medium text-slate-500 hover:bg-slate-50" data-country="custom">Custom</button>
                    </div>
                    <div class="relative flex-1 max-w-xs ml-auto">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="text" id="dest-search-full" placeholder="Search destinations..."
                               class="w-full pl-10 pr-4 py-2.5 bg-white rounded-xl text-sm shadow-sm focus:ring-2 focus:ring-sky-500 transition-all"
                               oninput="applyAllFilters()">
                    </div>
                </div>

                <!-- Advanced Filters Row -->
                <div class="flex flex-wrap items-center gap-2">
                    <span class="text-xs font-medium text-slate-500 uppercase tracking-wide mr-1">Filter:</span>

                    <!-- Duration Filter -->
                    <div class="flex items-center gap-1 bg-white rounded-lg p-0.5 shadow-sm">
                        <button onclick="toggleDuration('all')" class="duration-filter px-3 py-1.5 rounded-md text-xs font-medium bg-sky-100 text-sky-700" data-duration="all">
                            <i class="far fa-clock mr-1"></i>Any
                        </button>
                        <button onclick="toggleDuration('quick')" class="duration-filter px-3 py-1.5 rounded-md text-xs font-medium text-slate-500 hover:bg-slate-50" data-duration="quick">
                            Quick
                        </button>
                        <button onclick="toggleDuration('half')" class="duration-filter px-3 py-1.5 rounded-md text-xs font-medium text-slate-500 hover:bg-slate-50" data-duration="half">
                            ½ day
                        </button>
                        <button onclick="toggleDuration('full')" class="duration-filter px-3 py-1.5 rounded-md text-xs font-medium text-slate-500 hover:bg-slate-50" data-duration="full">
                            Full day
                        </button>
                        <button onclick="toggleDuration('multi')" class="duration-filter px-3 py-1.5 rounded-md text-xs font-medium text-slate-500 hover:bg-slate-50" data-duration="multi">
                            Multi-day
                        </button>
                    </div>

                    <!-- Cost Filter -->
                    <div class="flex items-center gap-1 bg-white rounded-lg p-0.5 shadow-sm">
                        <button onclick="toggleCost('all')" class="cost-filter px-3 py-1.5 rounded-md text-xs font-medium bg-emerald-100 text-emerald-700" data-cost="all">
                            <i class="fas fa-dollar-sign mr-1"></i>Any
                        </button>
                        <button onclick="toggleCost('free')" class="cost-filter px-3 py-1.5 rounded-md text-xs font-medium text-slate-500 hover:bg-slate-50" data-cost="free">
                            Free
                        </button>
                        <button onclick="toggleCost('budget')" class="cost-filter px-3 py-1.5 rounded-md text-xs font-medium text-slate-500 hover:bg-slate-50" data-cost="budget">
                            $1-25
                        </button>
                        <button onclick="toggleCost('mid')" class="cost-filter px-3 py-1.5 rounded-md text-xs font-medium text-slate-500 hover:bg-slate-50" data-cost="mid">
                            $26-75
                        </button>
                        <button onclick="toggleCost('premium')" class="cost-filter px-3 py-1.5 rounded-md text-xs font-medium text-slate-500 hover:bg-slate-50" data-cost="premium">
                            $76+
                        </button>
                    </div>

                    <!-- Crowds Filter -->
                    <div class="flex items-center gap-1 bg-white rounded-lg p-0.5 shadow-sm">
                        <button onclick="toggleCrowds('all')" class="crowds-filter px-3 py-1.5 rounded-md text-xs font-medium bg-amber-100 text-amber-700" data-crowds="all">
                            <i class="fas fa-users mr-1"></i>Any
                        </button>
                        <button onclick="toggleCrowds('low')" class="crowds-filter px-3 py-1.5 rounded-md text-xs font-medium text-slate-500 hover:bg-slate-50" data-crowds="low">
                            Quiet
                        </button>
                        <button onclick="toggleCrowds('moderate')" class="crowds-filter px-3 py-1.5 rounded-md text-xs font-medium text-slate-500 hover:bg-slate-50" data-crowds="moderate">
                            Moderate
                        </button>
                        <button onclick="toggleCrowds('high')" class="crowds-filter px-3 py-1.5 rounded-md text-xs font-medium text-slate-500 hover:bg-slate-50" data-crowds="high">
                            Busy
                        </button>
                    </div>

                    <!-- Clear Filters -->
                    <button onclick="clearAllFilters()" class="px-3 py-1.5 rounded-md text-xs font-medium text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-colors">
                        <i class="fas fa-times mr-1"></i>Clear
                    </button>
                </div>

                <!-- Active filters count -->
                <div id="filter-summary" class="hidden text-xs text-slate-500">
                    Showing <span id="visible-count" class="font-semibold text-slate-700">0</span> of <span id="total-count" class="font-semibold">0</span> destinations
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" id="destinations-grid">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- Decisions Tab -->
        <div id="content-decisions" class="hidden fade-in">
            <!-- NYE Decision -->
            <div class="card p-6 mb-6">
                <div class="flex items-start gap-4 mb-6">
                    <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-white flex-shrink-0">
                        <i class="fas fa-sparkles text-lg"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-slate-800">Where will you ring in 2026?</h3>
                        <p class="text-slate-500 mt-1">You arrive Dec 28. NYE is Dec 31 - just 3 days to position yourself.</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Recommended Option -->
                    <div class="relative bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl p-5 border-2 border-purple-200 cursor-pointer hover:border-purple-400 transition-all" onclick="selectNYE('chiang-mai')">
                        <div class="absolute -top-3 left-4">
                            <span class="bg-gradient-to-r from-purple-500 to-pink-500 text-white text-xs font-bold px-3 py-1 rounded-full">RECOMMENDED</span>
                        </div>
                        <h4 class="font-bold text-lg text-purple-800 mt-2 mb-3">Chiang Mai Lanterns</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-star text-amber-400 w-4"></i>
                                <span class="text-slate-600">Once-in-a-lifetime experience</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-users text-slate-400 w-4"></i>
                                <span class="text-slate-600">Very high crowds</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-dollar-sign text-emerald-500 w-4"></i>
                                <span class="text-slate-600">$50-150 ticket</span>
                            </div>
                        </div>
                        <p class="text-purple-700 text-sm mt-4">Thousands of lanterns released into the night sky. Magical and unforgettable.</p>
                    </div>

                    <!-- Bangkok -->
                    <div class="bg-white rounded-2xl p-5 border-2 border-slate-100 cursor-pointer hover:border-sky-300 transition-all" onclick="selectNYE('bangkok')">
                        <h4 class="font-bold text-lg text-slate-800 mb-3">Bangkok Rooftop</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-star text-amber-400 w-4"></i>
                                <span class="text-slate-600">Great city experience</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-users text-slate-400 w-4"></i>
                                <span class="text-slate-600">High crowds</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-dollar-sign text-emerald-500 w-4"></i>
                                <span class="text-slate-600">$30-100</span>
                            </div>
                        </div>
                        <p class="text-slate-500 text-sm mt-4">Fireworks over the skyline, rooftop bars, classic big city NYE.</p>
                    </div>

                    <!-- Koh Tao -->
                    <div class="bg-white rounded-2xl p-5 border-2 border-slate-100 cursor-pointer hover:border-sky-300 transition-all" onclick="selectNYE('koh-tao')">
                        <h4 class="font-bold text-lg text-slate-800 mb-3">Koh Tao Beach</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-star text-amber-400 w-4"></i>
                                <span class="text-slate-600">Chill beach vibes</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-users text-slate-400 w-4"></i>
                                <span class="text-slate-600">Moderate crowds</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-dollar-sign text-emerald-500 w-4"></i>
                                <span class="text-slate-600">Budget-friendly</span>
                            </div>
                        </div>
                        <p class="text-slate-500 text-sm mt-4">Beach party vibes. Could start scuba on Jan 1.</p>
                    </div>
                </div>

                <div class="mt-6 p-4 bg-amber-50 rounded-xl flex items-start gap-3">
                    <i class="fas fa-lightbulb text-amber-500 mt-0.5"></i>
                    <p class="text-sm text-amber-800">
                        <strong>Timing note:</strong> If you choose Chiang Mai for NYE, scuba starts Jan 2+. For earlier scuba, pick Bangkok or Koh Tao.
                    </p>
                </div>
            </div>

            <!-- Must-Do Checklist -->
            <div class="card p-6 mb-6">
                <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-emerald-100 flex items-center justify-center">
                        <i class="fas fa-check-double text-emerald-600"></i>
                    </div>
                    Must-Do Checklist
                </h3>
                <div class="space-y-2">
                    <label class="flex items-center gap-4 p-4 bg-red-50 rounded-xl cursor-pointer hover:bg-red-100 transition-colors border-2 border-red-200">
                        <input type="checkbox" class="w-5 h-5 rounded-md text-red-500 focus:ring-red-500" id="check-scuba">
                        <div class="flex-1">
                            <span class="font-semibold text-slate-800">Scuba Certification - Koh Tao</span>
                            <span class="text-sm text-slate-500 ml-2">(3-4 days)</span>
                        </div>
                        <span class="text-xs font-bold bg-red-500 text-white px-2 py-1 rounded-md">MUST DO</span>
                    </label>
                    <label class="flex items-center gap-4 p-4 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100 transition-colors">
                        <input type="checkbox" class="w-5 h-5 rounded-md text-sky-500 focus:ring-sky-500" id="check-angkor">
                        <span class="font-medium text-slate-700">Angkor Wat (if doing Cambodia)</span>
                    </label>
                    <label class="flex items-center gap-4 p-4 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100 transition-colors">
                        <input type="checkbox" class="w-5 h-5 rounded-md text-sky-500 focus:ring-sky-500" id="check-lantern">
                        <span class="font-medium text-slate-700">Chiang Mai NYE Lantern Festival</span>
                    </label>
                    <label class="flex items-center gap-4 p-4 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100 transition-colors">
                        <input type="checkbox" class="w-5 h-5 rounded-md text-sky-500 focus:ring-sky-500" id="check-elephant">
                        <span class="font-medium text-slate-700">Ethical Elephant Sanctuary</span>
                    </label>
                    <label class="flex items-center gap-4 p-4 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100 transition-colors">
                        <input type="checkbox" class="w-5 h-5 rounded-md text-sky-500 focus:ring-sky-500" id="check-cooking">
                        <span class="font-medium text-slate-700">Thai Cooking Class</span>
                    </label>
                    <label class="flex items-center gap-4 p-4 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100 transition-colors">
                        <input type="checkbox" class="w-5 h-5 rounded-md text-sky-500 focus:ring-sky-500" id="check-climbing">
                        <span class="font-medium text-slate-700">Rock Climbing at Railay</span>
                    </label>
                </div>
            </div>

            <!-- Comparison Table -->
            <div class="card p-6 overflow-hidden">
                <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-sky-100 flex items-center justify-center">
                        <i class="fas fa-route text-sky-600"></i>
                    </div>
                    Compare Options
                </h3>
                <div class="overflow-x-auto -mx-6 px-6">
                    <table class="w-full text-sm min-w-[500px]">
                        <thead>
                            <tr>
                                <th class="text-left py-3 px-4 text-slate-500 font-medium"></th>
                                <th class="text-left py-3 px-4 bg-amber-50 rounded-tl-lg font-semibold text-amber-700">Thailand Only</th>
                                <th class="text-left py-3 px-4 bg-rose-50 font-semibold text-rose-700">+ Cambodia</th>
                                <th class="text-left py-3 px-4 bg-emerald-50 rounded-tr-lg font-semibold text-emerald-700">All Three</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <tr>
                                <td class="py-3 px-4 font-medium text-slate-600">Pace</td>
                                <td class="py-3 px-4 bg-amber-50"><span class="inline-flex items-center gap-1 text-emerald-600"><i class="fas fa-leaf"></i> Relaxed</span></td>
                                <td class="py-3 px-4 bg-rose-50"><span class="inline-flex items-center gap-1 text-amber-600"><i class="fas fa-walking"></i> Moderate</span></td>
                                <td class="py-3 px-4 bg-emerald-50"><span class="inline-flex items-center gap-1 text-red-600"><i class="fas fa-running"></i> Fast</span></td>
                            </tr>
                            <tr>
                                <td class="py-3 px-4 font-medium text-slate-600">Angkor Wat</td>
                                <td class="py-3 px-4 bg-amber-50"><i class="fas fa-times text-slate-300"></i></td>
                                <td class="py-3 px-4 bg-rose-50"><i class="fas fa-check text-emerald-500"></i></td>
                                <td class="py-3 px-4 bg-emerald-50"><i class="fas fa-check text-emerald-500"></i></td>
                            </tr>
                            <tr>
                                <td class="py-3 px-4 font-medium text-slate-600">Taiwan</td>
                                <td class="py-3 px-4 bg-amber-50"><i class="fas fa-times text-slate-300"></i></td>
                                <td class="py-3 px-4 bg-rose-50"><i class="fas fa-times text-slate-300"></i></td>
                                <td class="py-3 px-4 bg-emerald-50"><i class="fas fa-check text-emerald-500"></i> <span class="text-xs text-slate-500">(limited)</span></td>
                            </tr>
                            <tr>
                                <td class="py-3 px-4 font-medium text-slate-600">Flights</td>
                                <td class="py-3 px-4 bg-amber-50">3-4</td>
                                <td class="py-3 px-4 bg-rose-50">5-6</td>
                                <td class="py-3 px-4 bg-emerald-50">7-8</td>
                            </tr>
                            <tr>
                                <td class="py-3 px-4 font-medium text-slate-600">Est. Budget</td>
                                <td class="py-3 px-4 bg-amber-50 font-semibold">$2,200</td>
                                <td class="py-3 px-4 bg-rose-50 font-semibold">$2,400</td>
                                <td class="py-3 px-4 bg-emerald-50 font-semibold">$3,000+</td>
                            </tr>
                            <tr>
                                <td class="py-3 px-4 font-medium text-slate-600">Best For</td>
                                <td class="py-3 px-4 bg-amber-50 rounded-bl-lg text-slate-600">Relaxation seekers</td>
                                <td class="py-3 px-4 bg-rose-50 text-slate-600">Balance seekers</td>
                                <td class="py-3 px-4 bg-emerald-50 rounded-br-lg text-slate-600">Adventure maximizers</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Logistics Tab -->
        <div id="content-logistics" class="hidden fade-in">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Visa Info -->
                <div class="card p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-sky-100 flex items-center justify-center">
                            <i class="fas fa-passport text-sky-600"></i>
                        </div>
                        Visa Requirements
                    </h3>
                    <div class="space-y-3">
                        <div class="flex items-center gap-4 p-4 bg-amber-50 rounded-xl">
                            <div class="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-check text-emerald-600"></i>
                            </div>
                            <div>
                                <div class="font-semibold text-slate-800">Thailand</div>
                                <div class="text-sm text-slate-600">Visa-free 60 days. FREE</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-4 p-4 bg-rose-50 rounded-xl">
                            <div class="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-file-alt text-amber-600"></i>
                            </div>
                            <div>
                                <div class="font-semibold text-slate-800">Cambodia</div>
                                <div class="text-sm text-slate-600">e-Visa required. $36 at evisa.gov.kh</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-4 p-4 bg-emerald-50 rounded-xl">
                            <div class="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-check text-emerald-600"></i>
                            </div>
                            <div>
                                <div class="font-semibold text-slate-800">Taiwan</div>
                                <div class="text-sm text-slate-600">Visa-free 90 days. FREE</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Currency -->
                <div class="card p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-emerald-100 flex items-center justify-center">
                            <i class="fas fa-money-bill-wave text-emerald-600"></i>
                        </div>
                        Currency & Tipping
                    </h3>
                    <div class="space-y-3">
                        <div class="p-4 bg-amber-50 rounded-xl">
                            <div class="flex justify-between font-semibold text-slate-800">
                                <span>Thailand (THB)</span>
                                <span class="text-slate-600">~35 = $1</span>
                            </div>
                            <div class="text-sm text-slate-600 mt-1">Tip 20-50 THB or round up</div>
                        </div>
                        <div class="p-4 bg-rose-50 rounded-xl">
                            <div class="flex justify-between font-semibold text-slate-800">
                                <span>Cambodia</span>
                                <span class="text-slate-600">USD accepted!</span>
                            </div>
                            <div class="text-sm text-slate-600 mt-1">Round up $1. Guides: $5-10/day</div>
                        </div>
                        <div class="p-4 bg-emerald-50 rounded-xl">
                            <div class="flex justify-between font-semibold text-slate-800">
                                <span>Taiwan (NT$)</span>
                                <span class="text-slate-600">~32 = $1</span>
                            </div>
                            <div class="text-sm text-slate-600 mt-1">NO TIPPING - it's not customary</div>
                        </div>
                    </div>
                </div>

                <!-- Flights -->
                <div class="card p-6 lg:col-span-2">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-violet-100 flex items-center justify-center">
                            <i class="fas fa-plane text-violet-600"></i>
                        </div>
                        Flight Connections
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="p-4 bg-slate-50 rounded-xl">
                            <h4 class="font-semibold text-amber-700 mb-3">From Bangkok</h4>
                            <ul class="space-y-2 text-sm text-slate-600">
                                <li class="flex justify-between"><span>→ Chiang Mai</span><span class="font-medium">1h 15m, $30-60</span></li>
                                <li class="flex justify-between"><span>→ Krabi</span><span class="font-medium">1h 25m, $35-70</span></li>
                                <li class="flex justify-between"><span>→ Siem Reap</span><span class="font-medium">1h, $80-150</span></li>
                                <li class="flex justify-between"><span>→ Taipei</span><span class="font-medium">3h 30m, $200-400</span></li>
                            </ul>
                        </div>
                        <div class="p-4 bg-slate-50 rounded-xl">
                            <h4 class="font-semibold text-rose-700 mb-3">From Siem Reap</h4>
                            <ul class="space-y-2 text-sm text-slate-600">
                                <li class="flex justify-between"><span>→ Bangkok</span><span class="font-medium">1h, $80-150</span></li>
                                <li class="flex justify-between"><span>→ Taipei</span><span class="font-medium">via BKK, $250-400</span></li>
                            </ul>
                        </div>
                        <div class="p-4 bg-slate-50 rounded-xl">
                            <h4 class="font-semibold text-emerald-700 mb-3">Koh Tao Access</h4>
                            <ol class="space-y-2 text-sm text-slate-600 list-decimal list-inside">
                                <li>Fly to Surat Thani (1h, $40-70)</li>
                                <li>Van to pier + catamaran (2-4h)</li>
                                <li class="text-slate-500">Book: Lomprayah or Seatran</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- Important Notes -->
                <div class="card p-6 lg:col-span-2">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-amber-100 flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-amber-600"></i>
                        </div>
                        Important Dec-Feb Notes
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="p-4 bg-amber-50 border border-amber-200 rounded-xl">
                            <div class="font-semibold text-amber-800 mb-1">Peak Season</div>
                            <div class="text-sm text-slate-600">HIGH SEASON for all three countries. Book flights and hotels early!</div>
                        </div>
                        <div class="p-4 bg-rose-50 border border-rose-200 rounded-xl">
                            <div class="font-semibold text-rose-800 mb-1">NYE Price Spike</div>
                            <div class="text-sm text-slate-600">Dec 30 - Jan 2 prices spike everywhere. Book NYE accommodation NOW.</div>
                        </div>
                        <div class="p-4 bg-sky-50 border border-sky-200 rounded-xl">
                            <div class="font-semibold text-sky-800 mb-1">Weather</div>
                            <div class="text-sm text-slate-600">Thailand & Cambodia: Dry, pleasant (best time!). Taiwan: Cool, occasional rain.</div>
                        </div>
                        <div class="p-4 bg-red-100 border-2 border-red-300 rounded-xl">
                            <div class="font-bold text-red-800 mb-1 flex items-center gap-2">
                                <i class="fas fa-ban"></i> Taroko Gorge: SKIP IT
                            </div>
                            <div class="text-sm text-red-700">Mostly CLOSED (Dec 2025). April 2024 earthquake damage. 10+ year recovery. Highway restricted to 5 daily windows. No buses. Do Sun Moon Lake or Alishan instead.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Mobile Bottom Navigation -->
    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 bottom-nav z-50">
        <div class="flex justify-around py-2">
            <button onclick="showTab('planner')" id="mob-tab-planner" class="flex flex-col items-center py-2 px-4 text-sky-500">
                <i class="fas fa-map-marked-alt text-lg"></i>
                <span class="text-xs mt-1 font-medium">Plan</span>
            </button>
            <button onclick="showTab('destinations')" id="mob-tab-destinations" class="flex flex-col items-center py-2 px-4 text-slate-400">
                <i class="fas fa-compass text-lg"></i>
                <span class="text-xs mt-1 font-medium">Explore</span>
            </button>
            <button onclick="showTab('decisions')" id="mob-tab-decisions" class="flex flex-col items-center py-2 px-4 text-slate-400">
                <i class="fas fa-lightbulb text-lg"></i>
                <span class="text-xs mt-1 font-medium">Decide</span>
            </button>
            <button onclick="showTab('logistics')" id="mob-tab-logistics" class="flex flex-col items-center py-2 px-4 text-slate-400">
                <i class="fas fa-info-circle text-lg"></i>
                <span class="text-xs mt-1 font-medium">Info</span>
            </button>
        </div>
    </nav>

    <!-- Collaboration Floating Button -->
    <div class="fixed bottom-24 md:bottom-8 right-4 z-50">
        <button onclick="showCollabModal()"
                class="w-14 h-14 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 text-white shadow-lg hover:shadow-xl hover:scale-105 transition-all flex items-center justify-center">
            <i class="fas fa-users text-lg"></i>
        </button>
    </div>

    <!-- Collaboration Modal -->
    <div id="collab-modal" class="fixed inset-0 bg-black/50 z-[60] hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 slide-up">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-slate-800">
                    <i class="fas fa-users mr-2 text-purple-500"></i>Collaborate
                </h2>
                <button onclick="closeCollabModal()" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 hover:text-slate-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- User status -->
            <div id="collab-user" class="mb-4 p-3 bg-slate-50 rounded-xl flex items-center gap-3">
                <div id="user-avatar" class="w-10 h-10 rounded-full bg-slate-300 flex items-center justify-center text-white">
                    <i class="fas fa-user"></i>
                </div>
                <div class="flex-1">
                    <p id="user-name" class="font-medium text-slate-700">Not signed in</p>
                    <p id="user-email" class="text-xs text-slate-500"></p>
                </div>
                <button id="sign-in-btn" onclick="signInWithGoogle()" class="px-3 py-1.5 bg-white border border-slate-200 rounded-lg text-sm hover:bg-slate-50 flex items-center gap-2">
                    <img src="https://www.google.com/favicon.ico" class="w-4 h-4"> Sign in
                </button>
                <button id="sign-out-btn" onclick="signOut()" class="hidden px-3 py-1.5 text-slate-500 hover:text-slate-700 text-sm">
                    Sign out
                </button>
            </div>

            <!-- Not collaborating state -->
            <div id="collab-start" class="space-y-4">
                <div class="bg-purple-50 rounded-xl p-4">
                    <h3 class="font-semibold text-purple-800 mb-2">Create a Room</h3>
                    <p class="text-sm text-purple-600 mb-3">Start a session and share the code with Carter.</p>
                    <button onclick="handleCreateRoom()" class="w-full px-4 py-2.5 bg-purple-500 hover:bg-purple-600 text-white rounded-lg font-medium text-sm transition-colors">
                        <i class="fas fa-plus mr-2"></i>Create Room
                    </button>
                </div>

                <div class="flex items-center gap-3">
                    <div class="flex-1 h-px bg-slate-200"></div>
                    <span class="text-xs text-slate-400">OR</span>
                    <div class="flex-1 h-px bg-slate-200"></div>
                </div>

                <div class="bg-sky-50 rounded-xl p-4">
                    <h3 class="font-semibold text-sky-800 mb-2">Join a Room</h3>
                    <p class="text-sm text-sky-600 mb-3">Enter the code shared with you.</p>
                    <div class="flex gap-2">
                        <input type="text" id="join-code" placeholder="Enter 6-char code"
                               class="flex-1 px-4 py-2 bg-white rounded-lg text-sm border border-sky-200 focus:ring-2 focus:ring-sky-500 uppercase tracking-widest font-mono text-center text-lg"
                               maxlength="6">
                        <button onclick="handleJoinRoom()" class="px-4 py-2 bg-sky-500 hover:bg-sky-600 text-white rounded-lg font-medium text-sm transition-colors">
                            Join
                        </button>
                    </div>
                </div>
            </div>

            <!-- Collaborating state -->
            <div id="collab-active" class="hidden space-y-4">
                <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-4 text-center">
                    <p class="text-sm text-slate-500 mb-1">Room Code</p>
                    <p id="active-room-code" class="text-3xl font-bold text-purple-700 tracking-widest font-mono">------</p>
                    <button onclick="copyRoomLink()" class="mt-3 text-sm text-purple-600 hover:text-purple-800 flex items-center gap-1 mx-auto">
                        <i class="fas fa-copy"></i> Copy Link
                    </button>
                </div>

                <div class="bg-slate-50 rounded-xl p-4">
                    <h3 class="font-semibold text-slate-700 mb-3">
                        <i class="fas fa-users mr-2"></i>Members
                    </h3>
                    <div id="members-list" class="space-y-2">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <button onclick="leaveRoom()" class="w-full py-3 text-red-600 hover:bg-red-50 rounded-xl transition-colors text-sm font-medium">
                    <i class="fas fa-sign-out-alt mr-2"></i>Leave Room
                </button>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="modal" class="fixed inset-0 bg-black/60 z-[100] hidden items-end md:items-center justify-center">
        <div class="bg-white w-full md:max-w-lg md:rounded-2xl rounded-t-3xl max-h-[85vh] overflow-hidden slide-up">
            <div class="p-6 overflow-y-auto max-h-[85vh]" id="modal-content">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- Create Custom Modal -->
    <div id="custom-modal" class="fixed inset-0 bg-black/60 z-[100] hidden items-end md:items-center justify-center">
        <div class="bg-white w-full md:max-w-lg md:rounded-2xl rounded-t-3xl max-h-[90vh] overflow-hidden slide-up">
            <div class="p-6 overflow-y-auto max-h-[90vh]">
                <div class="flex items-start justify-between mb-5">
                    <div>
                        <h2 id="custom-modal-title" class="text-xl font-bold text-slate-800">Add Custom Activity</h2>
                        <p class="text-sm text-slate-500 mt-1">Create your own destination or activity</p>
                    </div>
                    <button onclick="closeCustomModal()" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 hover:text-slate-600 hover:bg-slate-200 transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <form id="custom-form" onsubmit="saveCustomActivity(event)" class="space-y-4">
                    <!-- Name -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1.5">Activity Name *</label>
                        <input type="text" id="custom-name" required placeholder="e.g., Hidden Rooftop Bar"
                               class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 focus:bg-white transition-all">
                    </div>

                    <!-- Country & Region -->
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1.5">Country *</label>
                            <select id="custom-country" required class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="thailand">Thailand</option>
                                <option value="cambodia">Cambodia</option>
                                <option value="taiwan">Taiwan</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1.5">City/Region *</label>
                            <input type="text" id="custom-region" required placeholder="e.g., Bangkok"
                                   class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 focus:bg-white transition-all">
                        </div>
                    </div>

                    <!-- Type -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1.5">Type</label>
                        <select id="custom-type" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="activity">Activity</option>
                            <option value="food">Food & Dining</option>
                            <option value="nightlife">Nightlife</option>
                            <option value="temple">Temple</option>
                            <option value="nature">Nature</option>
                            <option value="beach">Beach</option>
                            <option value="market">Market</option>
                            <option value="culture">Culture</option>
                            <option value="wellness">Wellness</option>
                            <option value="neighborhood">Neighborhood</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <!-- Duration & Cost -->
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1.5">Duration (days)</label>
                            <select id="custom-days" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="0.25">Quick (~1-2 hours)</option>
                                <option value="0.5" selected>Half day</option>
                                <option value="1">Full day</option>
                                <option value="1.5">1.5 days</option>
                                <option value="2">2 days</option>
                                <option value="3">3 days</option>
                                <option value="4">4 days</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1.5">Est. Cost (USD)</label>
                            <input type="number" id="custom-cost" min="0" value="0" placeholder="0"
                                   class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 focus:bg-white transition-all">
                        </div>
                    </div>

                    <!-- Crowds -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1.5">Expected Crowds</label>
                        <div class="flex gap-2">
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="custom-crowds" value="LOW" class="sr-only peer">
                                <div class="text-center py-2 px-3 rounded-lg border-2 border-slate-200 text-sm font-medium text-slate-600 peer-checked:border-emerald-500 peer-checked:bg-emerald-50 peer-checked:text-emerald-700 transition-all">
                                    Quiet
                                </div>
                            </label>
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="custom-crowds" value="MODERATE" class="sr-only peer" checked>
                                <div class="text-center py-2 px-3 rounded-lg border-2 border-slate-200 text-sm font-medium text-slate-600 peer-checked:border-amber-500 peer-checked:bg-amber-50 peer-checked:text-amber-700 transition-all">
                                    Moderate
                                </div>
                            </label>
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="custom-crowds" value="HIGH" class="sr-only peer">
                                <div class="text-center py-2 px-3 rounded-lg border-2 border-slate-200 text-sm font-medium text-slate-600 peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 transition-all">
                                    Busy
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Description -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1.5">Description</label>
                        <textarea id="custom-desc" rows="2" placeholder="What is this place? Why do you want to go?"
                                  class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 focus:bg-white transition-all resize-none"></textarea>
                    </div>

                    <!-- Tips -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1.5">Notes/Tips</label>
                        <textarea id="custom-tips" rows="2" placeholder="Any tips, booking info, or things to remember?"
                                  class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 focus:bg-white transition-all resize-none"></textarea>
                    </div>

                    <!-- Highlight -->
                    <label class="flex items-center gap-3 p-3 bg-amber-50 rounded-xl cursor-pointer">
                        <input type="checkbox" id="custom-highlight" class="w-5 h-5 rounded text-amber-500 focus:ring-amber-500">
                        <div>
                            <span class="font-medium text-slate-700">Mark as Must-See</span>
                            <span class="text-sm text-slate-500 block">Highlight this as a priority activity</span>
                        </div>
                    </label>

                    <!-- Hidden field for editing -->
                    <input type="hidden" id="custom-edit-id" value="">

                    <!-- Buttons -->
                    <div class="flex gap-3 pt-2">
                        <button type="button" onclick="closeCustomModal()" class="flex-1 btn-secondary">Cancel</button>
                        <button type="submit" class="flex-1 btn-primary">
                            <i class="fas fa-plus mr-2"></i><span id="custom-submit-text">Add Activity</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCrRTJnsjPwAbXIH_9zuxAIqgzAf0YzLNg",
            authDomain: "asia-trip-planner.firebaseapp.com",
            databaseURL: "https://asia-trip-planner-default-rtdb.firebaseio.com",
            projectId: "asia-trip-planner",
            storageBucket: "asia-trip-planner.firebasestorage.app",
            messagingSenderId: "132963685762",
            appId: "1:132963685762:web:7ed6d8ec5ff93c6c79ab9b"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Collaboration state
        let currentUser = null;
        let currentRoomCode = null;
        let roomRef = null;
        let isCollaborating = false;
        let itineraryListener = null;
        let customActivitiesListener = null;
        let isSyncingItinerary = false;
        let isSyncingCustom = false;
        let isInitialLoad = true; // Skip first listener fire after join
        let membersListener = null;

        // Destination Data
        const destinations = [
            // THAILAND - BANGKOK
            { id: 'wat-pho', name: 'Wat Pho', region: 'Bangkok', country: 'thailand', type: 'temple', days: 0.5, cost: 6, highlight: true,
              desc: 'Temple of the Reclining Buddha - one of Bangkok\'s oldest and largest temples with a 46m golden Buddha.',
              tips: 'Arrive at 8am opening to avoid crowds. Includes water bottle.', crowds: 'HIGH' },
            { id: 'grand-palace', name: 'Grand Palace', region: 'Bangkok', country: 'thailand', type: 'temple', days: 0.5, cost: 15, highlight: true,
              desc: 'Stunning palace complex with Wat Phra Kaew (Temple of the Emerald Buddha). The most famous landmark in Bangkok.',
              tips: 'Dress code enforced - cover shoulders and knees. Go early morning.', crowds: 'VERY HIGH' },
            { id: 'wat-arun', name: 'Wat Arun', region: 'Bangkok', country: 'thailand', type: 'temple', days: 0.5, cost: 3,
              desc: 'Temple of Dawn - stunning riverside temple with intricate porcelain decoration. Beautiful at sunset.',
              tips: 'Best photographed from across the river. Visit at sunset.', crowds: 'HIGH' },
            { id: 'chinatown', name: 'Chinatown/Yaowarat', region: 'Bangkok', country: 'thailand', type: 'neighborhood', days: 0.5, cost: 20,
              desc: 'Bangkok\'s vibrant Chinatown - endless street food stalls, gold shops, and chaotic energy.',
              tips: 'Come hungry after 6pm when street food stalls open. Try pad thai, dim sum, roast duck.', crowds: 'HIGH' },
            { id: 'chatuchak', name: 'Chatuchak Market', region: 'Bangkok', country: 'thailand', type: 'market', days: 0.5, cost: 30,
              desc: 'One of world\'s largest weekend markets. 15,000+ stalls selling everything imaginable.',
              tips: 'Only open Sat-Sun. Arrive early. Can negotiate 30-40% off.', crowds: 'VERY HIGH' },
            { id: 'jodd-fairs', name: 'JODD Fairs Night Market', region: 'Bangkok', country: 'thailand', type: 'nightlife', days: 0.5, cost: 25,
              desc: 'Trendy night market with amazing food, vintage shopping, and hip atmosphere.',
              tips: 'Best visited 7-10pm. Great photo ops.', crowds: 'HIGH' },
            { id: 'bkk-massage', name: 'Thai Massage', region: 'Bangkok', country: 'thailand', type: 'wellness', days: 0.25, cost: 15,
              desc: 'Authentic Thai massage at fraction of Western prices. 300-350 THB per hour is reasonable.',
              tips: 'Try Treasure Massage for scalp, Yunomori Onsen for Japanese-Thai fusion.', crowds: 'LOW' },
            { id: 'sky-bar', name: 'Sky Bar at Lebua', region: 'Bangkok', country: 'thailand', type: 'nightlife', days: 0.25, cost: 40,
              desc: 'Famous rooftop bar from The Hangover Part II. Spectacular city views.',
              tips: 'Dress code enforced. Drinks $15-20 each. Go for sunset.', crowds: 'HIGH' },

            // THAILAND - CHIANG MAI
            { id: 'doi-suthep', name: 'Wat Phra That Doi Suthep', region: 'Chiang Mai', country: 'thailand', type: 'temple', days: 0.5, cost: 3, highlight: true,
              desc: 'Sacred temple atop Doi Suthep mountain with golden chedi and panoramic city views.',
              tips: '309 steps or take cable car. Best early morning for clear views.', crowds: 'HIGH' },
            { id: 'cm-old-city', name: 'Old City Temples', region: 'Chiang Mai', country: 'thailand', type: 'temple', days: 0.5, cost: 5,
              desc: 'Walkable area with ancient temples - Wat Chedi Luang, Wat Phra Singh, Wat Chiang Man.',
              tips: 'Rent a bike to explore. Monk chats available at some temples.', crowds: 'MODERATE' },
            { id: 'khao-soi', name: 'Khao Soi Tour', region: 'Chiang Mai', country: 'thailand', type: 'food', days: 0.25, cost: 10, highlight: true,
              desc: 'Northern Thai coconut curry noodle soup - the signature Chiang Mai dish.',
              tips: 'Try Khao Soi Maesai (budget, daytime) or Khao Soi Nimman (fancy, Michelin).', crowds: 'MODERATE' },
            { id: 'night-bazaar', name: 'Night Bazaar', region: 'Chiang Mai', country: 'thailand', type: 'market', days: 0.5, cost: 25,
              desc: 'Evening market with handicrafts, clothing, food, and massage shops.',
              tips: 'Bargain! Start at 30-40% of asking price. Fah Lanna Spa is inside.', crowds: 'HIGH' },
            { id: 'elephant-sanctuary', name: 'Ethical Elephant Sanctuary', region: 'Chiang Mai', country: 'thailand', type: 'nature', days: 1, cost: 85, highlight: true,
              desc: 'No-riding elephant experiences at ethical sanctuaries. Feed, bathe, observe elephants.',
              tips: 'Book ahead - sells out in peak season. Elephant Nature Park or similar.', crowds: 'MODERATE' },
            { id: 'cooking-class', name: 'Thai Cooking Class', region: 'Chiang Mai', country: 'thailand', type: 'activity', days: 0.5, cost: 45, highlight: true,
              desc: 'Learn to make pad thai, curries, and more. Usually includes market visit.',
              tips: 'Thai Farm Cooking School is highly rated. Full day is more immersive.', crowds: 'LOW' },
            { id: 'doi-inthanon', name: 'Doi Inthanon National Park', region: 'Chiang Mai', country: 'thailand', type: 'nature', days: 1, cost: 40,
              desc: 'Thailand\'s highest peak with twin pagodas, waterfalls, and hill tribe villages.',
              tips: 'Bring warm layers - it\'s cold at summit! Full day trip recommended.', crowds: 'MODERATE' },
            { id: 'lantern-festival', name: 'NYE Lantern Festival', region: 'Chiang Mai', country: 'thailand', type: 'event', days: 1, cost: 100, highlight: true,
              desc: 'CAD Khomloy Sky Lantern Festival on Dec 31. Thousands of lanterns released into night sky.',
              tips: 'BOOK TICKETS NOW - sells out. Standard $50, VIP $100+. Once in a lifetime.', crowds: 'VERY HIGH' },
            { id: 'muay-thai', name: 'Muay Thai Fight Night', region: 'Chiang Mai', country: 'thailand', type: 'activity', days: 0.25, cost: 20,
              desc: 'Watch authentic Muay Thai boxing at local stadium.',
              tips: 'Multiple stadiums - Thapae is most tourist-friendly. VIP ~$45.', crowds: 'MODERATE' },

            // THAILAND - SOUTHERN
            { id: 'koh-tao-scuba', name: 'Scuba Certification', region: 'Koh Tao', country: 'thailand', type: 'activity', days: 4, cost: 350, highlight: true,
              desc: 'PADI Open Water certification at one of the world\'s best (and cheapest) places to learn.',
              tips: 'Top schools: Big Blue Diving, Ban\'s Diving, Davey Jones Locker. Book ahead.', crowds: 'MODERATE' },
            { id: 'shark-bay', name: 'Shark Bay Snorkeling', region: 'Koh Tao', country: 'thailand', type: 'nature', days: 0.5, cost: 15,
              desc: 'Snorkeling spot famous for blacktip reef sharks. They\'re harmless!',
              tips: 'Best 7-10am when sharks are feeding. Bring your own gear or rent.', crowds: 'MODERATE' },
            { id: 'khao-sok', name: 'Khao Sok / Cheow Lan Lake', region: 'Khao Sok', country: 'thailand', type: 'nature', days: 2, cost: 150, highlight: true,
              desc: 'Floating bungalows on stunning emerald lake surrounded by jungle and limestone cliffs.',
              tips: 'Overnight on floating bungalow is the experience. Book 2-day tour.', crowds: 'LOW' },
            { id: 'big-buddha', name: 'Big Buddha Temple', region: 'Ko Samui', country: 'thailand', type: 'temple', days: 0.25, cost: 0,
              desc: 'Iconic 12m golden Buddha statue on Koh Samui. Lots of stairs!',
              tips: 'Go at sunrise for photos and fewer crowds. Free entry.', crowds: 'MODERATE' },
            { id: 'railay', name: 'Railay Beach', region: 'Krabi', country: 'thailand', type: 'beach', days: 2, cost: 60, highlight: true,
              desc: 'Stunning peninsula only accessible by boat. Dramatic limestone cliffs, pristine beaches.',
              tips: 'Long-tail boat from Ao Nang. Wet landing - wear appropriate shoes.', crowds: 'HIGH' },
            { id: 'rock-climbing', name: 'Rock Climbing Railay', region: 'Krabi', country: 'thailand', type: 'activity', days: 0.5, cost: 35,
              desc: 'World-class limestone climbing. Half-day courses available for beginners.',
              tips: 'Multiple schools. No experience needed for intro course.', crowds: 'MODERATE' },
            { id: 'island-hopping', name: 'Four Islands Tour', region: 'Krabi', country: 'thailand', type: 'nature', days: 1, cost: 35,
              desc: 'Day trip to Hong Island, Poda, Chicken Island, and Tup. Snorkeling, beaches, lunch.',
              tips: 'Speedboat faster but louder. Long-tail more scenic. Book ahead.', crowds: 'HIGH' },
            { id: 'phra-nang', name: 'Phra Nang Cave Beach', region: 'Krabi', country: 'thailand', type: 'beach', days: 0.5, cost: 0,
              desc: 'Small beach with sacred cave shrine filled with wooden phalluses (fertility offerings).',
              tips: 'Walk from Railay East. Best for sunset. Very popular.', crowds: 'HIGH' },
            { id: 'phuket-old', name: 'Phuket Old Town', region: 'Phuket', country: 'thailand', type: 'neighborhood', days: 0.5, cost: 20,
              desc: 'Charming Sino-Portuguese architecture, street art, cafes, and Sunday walking street.',
              tips: 'Sunday market is great. UNESCO City of Gastronomy.', crowds: 'MODERATE' },
            { id: 'james-bond', name: 'James Bond Island', region: 'Phuket', country: 'thailand', type: 'nature', days: 1, cost: 80,
              desc: 'Phang Nga Bay tour to the famous limestone karst from "The Man with the Golden Gun".',
              tips: 'Very touristy but impressive. Combine with sea cave kayaking.', crowds: 'VERY HIGH' },

            // CAMBODIA
            { id: 'angkor-wat', name: 'Angkor Wat', region: 'Siem Reap', country: 'cambodia', type: 'temple', days: 2, cost: 75, highlight: true,
              desc: 'World\'s largest religious monument. Absolutely stunning Khmer architecture.',
              tips: 'Get 3-day pass ($62). Hire guide. Sunrise is magical but crowded.', crowds: 'VERY HIGH' },
            { id: 'ta-prohm', name: 'Ta Prohm', region: 'Siem Reap', country: 'cambodia', type: 'temple', days: 0.5, cost: 0, highlight: true,
              desc: '"Tomb Raider temple" - massive tree roots consuming ancient stone ruins.',
              tips: 'Included in Angkor pass. Best late afternoon light.', crowds: 'HIGH' },
            { id: 'bayon', name: 'Bayon Temple', region: 'Siem Reap', country: 'cambodia', type: 'temple', days: 0.5, cost: 0, highlight: true,
              desc: '216 giant serene stone faces carved into towers. Mesmerizing.',
              tips: 'Included in Angkor pass. Early morning or late afternoon best.', crowds: 'HIGH' },
            { id: 'floating-village', name: 'Kompong Phluk Floating Village', region: 'Siem Reap', country: 'cambodia', type: 'nature', days: 0.5, cost: 40,
              desc: 'Village on stilts on Tonle Sap lake. Unique glimpse into water-based life.',
              tips: 'Afternoon tours best for sunset photos. Book ahead in peak season.', crowds: 'MODERATE' },
            { id: 'apsara', name: 'Apsara Dance Show', region: 'Siem Reap', country: 'cambodia', type: 'activity', days: 0.25, cost: 30,
              desc: 'Classical Khmer dance with elaborate costumes. Usually includes buffet dinner.',
              tips: 'Book through hotel. Drinks usually extra.', crowds: 'LOW' },
            { id: 'royal-palace-pp', name: 'Royal Palace', region: 'Phnom Penh', country: 'cambodia', type: 'temple', days: 0.5, cost: 10,
              desc: 'Stunning palace complex where the King still lives. Silver Pagoda included.',
              tips: 'CASH ONLY. Dress code enforced. Half day with nearby museum.', crowds: 'MODERATE' },
            { id: 'tuol-sleng', name: 'Tuol Sleng Genocide Museum', region: 'Phnom Penh', country: 'cambodia', type: 'culture', days: 0.5, cost: 5,
              desc: 'Former S-21 prison from Khmer Rouge era. Heavy but essential for understanding Cambodia.',
              tips: 'Allow 2-3 hours. Often combined with Killing Fields.', crowds: 'MODERATE' },
            { id: 'koh-rong', name: 'Koh Rong Island', region: 'Koh Rong', country: 'cambodia', type: 'beach', days: 2, cost: 80,
              desc: 'Pristine beaches, bioluminescent plankton, tropical paradise.',
              tips: 'Ferry from Sihanoukville. Stay at Long Set for quiet. Bioluminescence tour $6!', crowds: 'MODERATE' },

            // TAIWAN
            { id: 'jiufen', name: 'Jiufen', region: 'Taipei Area', country: 'taiwan', type: 'neighborhood', days: 0.5, cost: 15, highlight: true,
              desc: '"Spirited Away" village - lantern-lit alleys, tea houses, ocean views.',
              tips: 'Go late afternoon for lanterns lighting. Rainy weather adds atmosphere!', crowds: 'HIGH' },
            { id: 'beitou', name: 'Beitou Hot Springs', region: 'Taipei Area', country: 'taiwan', type: 'wellness', days: 0.5, cost: 20,
              desc: 'Metro-accessible hot spring district. Public baths from $1, private from $15.',
              tips: 'Just 40 min from central Taipei by MRT. Perfect rainy day activity.', crowds: 'MODERATE' },
            { id: 'taroko', name: 'Taroko Gorge', region: 'Hualien', country: 'taiwan', type: 'nature', days: 1, cost: 0, closed: true,
              desc: 'MOSTLY CLOSED (Dec 2025). April 2024 earthquake damage. Shakadang, Zhuilu, Swallow Grotto all CLOSED. Recovery: 10+ years.',
              tips: 'NOT RECOMMENDED. Access windows: 6:30-8am, 10-10:05am, 12-1pm, 3-3:05pm, 4:30-5:30pm only. Consider Sun Moon Lake or Alishan instead.', crowds: 'N/A - Limited' },
            { id: 'alishan', name: 'Alishan Forest Railway', region: 'Chiayi', country: 'taiwan', type: 'nature', days: 1.5, cost: 50, highlight: true,
              desc: 'Historic narrow-gauge railway through mountains. Famous sunrise above clouds.',
              tips: 'Book sunrise train 2 weeks ahead - sells out! Bring warm clothes.', crowds: 'MODERATE' },
            { id: 'sun-moon-lake', name: 'Sun Moon Lake', region: 'Taichung', country: 'taiwan', type: 'nature', days: 1, cost: 40, highlight: true,
              desc: 'Taiwan\'s largest lake. CNN top 10 bike route. Cycling, boats, ropeway.',
              tips: 'Rent electric bike for 29km loop. Stay overnight for sunrise.', crowds: 'MODERATE' },
            { id: 'taichung-theater', name: 'National Taichung Theater', region: 'Taichung', country: 'taiwan', type: 'culture', days: 0.25, cost: 0,
              desc: 'Stunning Toyo Ito architecture - no right angles. Free to explore.',
              tips: 'Worth visiting even without a show. Rooftop garden has city views.', crowds: 'LOW' },
            { id: 'kenting', name: 'Kenting National Park', region: 'Southern Taiwan', country: 'taiwan', type: 'beach', days: 1, cost: 5,
              desc: 'Taiwan\'s Hawaii - tropical beaches, surfing, 2km night market.',
              tips: 'Dec-Feb is off-peak (quieter but windy). Long trip from Taipei.', crowds: 'LOW' },
        ];

        // Trip dates
        const tripDays = [];
        const startDate = new Date('2025-12-28');
        for (let i = 0; i < 20; i++) {
            const date = new Date(startDate);
            date.setDate(date.getDate() + i);
            tripDays.push({
                day: i + 1,
                date: date,
                dateStr: date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }),
                shortDate: date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                isNYE: date.getMonth() === 11 && date.getDate() === 31,
                destinations: []
            });
        }

        // Itinerary state
        let itinerary = JSON.parse(localStorage.getItem('asiaItinerary')) || {};
        let customActivities = JSON.parse(localStorage.getItem('asiaCustomActivities')) || [];
        let currentCountryFilter = 'all';
        let currentDurationFilter = 'all';
        let currentCostFilter = 'all';
        let currentCrowdsFilter = 'all';
        let currentTab = 'planner';

        // Get all destinations (built-in + custom)
        function getAllDestinations() {
            return [...destinations, ...customActivities];
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            renderDestinationList();
            renderCalendar();
            renderDestinationsGrid();
            loadItinerary();
            updateBudget();
            updateDestCount();
        });

        // Tab switching
        function showTab(tab) {
            currentTab = tab;
            // Hide all content
            document.querySelectorAll('[id^="content-"]').forEach(el => el.classList.add('hidden'));
            // Reset desktop tabs
            document.querySelectorAll('[id^="tab-"]').forEach(el => {
                el.classList.remove('tab-active');
                el.classList.add('text-slate-500');
            });
            // Reset mobile tabs
            document.querySelectorAll('[id^="mob-tab-"]').forEach(el => {
                el.classList.remove('text-sky-500');
                el.classList.add('text-slate-400');
            });

            // Show selected content
            const content = document.getElementById(`content-${tab}`);
            content.classList.remove('hidden');
            content.classList.add('fade-in');

            // Activate desktop tab
            const desktopTab = document.getElementById(`tab-${tab}`);
            if (desktopTab) {
                desktopTab.classList.add('tab-active');
                desktopTab.classList.remove('text-slate-500');
            }

            // Activate mobile tab
            const mobileTab = document.getElementById(`mob-tab-${tab}`);
            if (mobileTab) {
                mobileTab.classList.remove('text-slate-400');
                mobileTab.classList.add('text-sky-500');
            }
        }

        // Update destination count
        function updateDestCount() {
            const total = getAllDestinations().length;
            const customCount = customActivities.length;
            const text = customCount > 0 ? `${total} places (${customCount} custom)` : `${total} places`;
            document.getElementById('dest-count').textContent = text;
        }

        // Render sidebar destination list
        function renderDestinationList() {
            const list = document.getElementById('destination-list');
            const countries = [
                { key: 'thailand', label: 'Thailand', color: 'amber' },
                { key: 'cambodia', label: 'Cambodia', color: 'rose' },
                { key: 'taiwan', label: 'Taiwan', color: 'emerald' }
            ];

            let html = '';

            // Custom activities section (if any)
            if (customActivities.length > 0) {
                html += `<div class="mb-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="w-2 h-2 rounded-full bg-indigo-500"></span>
                        <span class="text-xs font-semibold text-indigo-600 uppercase tracking-wide">Your Custom</span>
                        <span class="text-xs text-slate-400">(${customActivities.length})</span>
                    </div>`;

                customActivities.forEach(dest => {
                    html += `
                        <div class="dest-card p-2.5 mb-1.5 rounded-xl bg-indigo-50 hover:bg-white hover:shadow-sm accent-custom"
                             draggable="true"
                             ondragstart="dragStart(event, '${dest.id}')"
                             ondragend="dragEnd(event)"
                             onclick="showDestinationDetail('${dest.id}')">
                            <div class="flex items-center justify-between">
                                <div class="flex-1 min-w-0">
                                    <div class="font-medium text-sm text-slate-800 truncate">${dest.name}</div>
                                    <div class="text-xs text-slate-500">${dest.region}</div>
                                </div>
                                ${dest.highlight ? '<i class="fas fa-star text-amber-400 text-xs"></i>' : ''}
                                <i class="fas fa-user-edit text-indigo-400 text-xs ml-1"></i>
                            </div>
                        </div>`;
                });
                html += '</div>';
            }

            countries.forEach(({ key, label, color }) => {
                const countryDests = destinations.filter(d => d.country === key);

                html += `<div class="mb-2">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="w-2 h-2 rounded-full bg-${color}-500"></span>
                        <span class="text-xs font-semibold text-slate-500 uppercase tracking-wide">${label}</span>
                        <span class="text-xs text-slate-400">(${countryDests.length})</span>
                    </div>`;

                countryDests.forEach(dest => {
                    const closedClass = dest.closed ? 'opacity-50' : '';
                    html += `
                        <div class="dest-card p-2.5 mb-1.5 rounded-xl bg-slate-50 hover:bg-white hover:shadow-sm accent-${key} ${closedClass}"
                             draggable="true"
                             ondragstart="dragStart(event, '${dest.id}')"
                             ondragend="dragEnd(event)"
                             onclick="showDestinationDetail('${dest.id}')">
                            <div class="flex items-center justify-between">
                                <div class="flex-1 min-w-0">
                                    <div class="font-medium text-sm text-slate-800 truncate">${dest.name}</div>
                                    <div class="text-xs text-slate-500">${dest.region}</div>
                                </div>
                                ${dest.highlight && !dest.closed ? '<i class="fas fa-star text-amber-400 text-xs"></i>' : ''}
                                ${dest.closed ? '<i class="fas fa-ban text-red-400 text-xs"></i>' : ''}
                            </div>
                        </div>`;
                });
                html += '</div>';
            });
            list.innerHTML = html;
        }

        // Render calendar grid
        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            let html = '';

            tripDays.forEach(day => {
                const nyeClass = day.isNYE ? 'nye-glow' : '';
                const nyeBadge = day.isNYE ? '<span class="absolute -top-2 right-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm">NYE</span>' : '';

                html += `
                    <div class="day-slot day-slot-empty rounded-xl p-3 min-h-[100px] relative transition-all ${nyeClass}"
                         ondragover="dragOver(event)"
                         ondragleave="dragLeave(event)"
                         ondrop="drop(event, ${day.day})"
                         data-day="${day.day}">
                        ${nyeBadge}
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs font-bold text-slate-400">Day ${day.day}</span>
                            <span class="text-xs text-slate-500">${day.shortDate}</span>
                        </div>
                        <div class="space-y-1.5 day-destinations" id="day-${day.day}-destinations"></div>
                    </div>`;
            });
            grid.innerHTML = html;
        }

        // Render full destinations grid
        function renderDestinationsGrid() {
            const grid = document.getElementById('destinations-grid');
            let html = '';
            const allDests = getAllDestinations();

            allDests.forEach(dest => {
                const isCustom = dest.isCustom;
                const closedClass = dest.closed ? 'dest-closed' : '';
                let badge = '';
                if (dest.closed) {
                    badge = '<span class="closed-badge"><i class="fas fa-ban mr-1"></i>Closed</span>';
                } else if (isCustom) {
                    badge = '<span class="custom-badge"><i class="fas fa-user-edit mr-1"></i>Custom</span>';
                } else if (dest.highlight) {
                    badge = '<span class="highlight-badge"><i class="fas fa-star mr-1"></i>Must See</span>';
                }

                html += `
                    <div class="card card-interactive p-5 ${closedClass}" data-country="${dest.country}" data-custom="${isCustom || false}" onclick="showDestinationDetail('${dest.id}')">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <h4 class="font-bold text-slate-800">${dest.name}</h4>
                                <p class="text-sm text-slate-500">${dest.region}</p>
                            </div>
                            ${badge}
                        </div>
                        <div class="flex flex-wrap gap-1.5 mb-3">
                            <span class="badge-${isCustom ? 'custom' : dest.country} text-xs px-2 py-1 rounded-lg font-medium">${dest.country}</span>
                            <span class="bg-slate-100 text-slate-600 text-xs px-2 py-1 rounded-lg">${dest.type}</span>
                        </div>
                        <p class="text-sm text-slate-600 mb-4 line-clamp-2">${dest.desc || 'No description'}</p>
                        <div class="flex items-center justify-between text-sm text-slate-500 pt-3 border-t border-slate-100">
                            <span><i class="far fa-clock mr-1"></i>${dest.days}d</span>
                            <span><i class="fas fa-dollar-sign mr-1"></i>${dest.cost}</span>
                            <span class="text-xs">${dest.crowds || 'N/A'}</span>
                        </div>
                    </div>`;
            });
            grid.innerHTML = html;
        }

        // Drag and drop
        function dragStart(e, destId) {
            e.dataTransfer.setData('destId', destId);
            e.target.classList.add('dragging');
        }

        function dragEnd(e) {
            e.target.classList.remove('dragging');
        }

        function dragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function dragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function drop(e, dayNum) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            const destId = e.dataTransfer.getData('destId');
            addToDay(destId, dayNum);
        }

        function addToDay(destId, dayNum) {
            if (!itinerary[dayNum]) itinerary[dayNum] = [];
            if (!itinerary[dayNum].includes(destId)) {
                itinerary[dayNum].push(destId);
                saveItinerary();
                renderDayDestinations(dayNum);
                updateBudget();
                updateDaySlotStyle(dayNum);
            }
        }

        function removeFromDay(destId, dayNum, e) {
            e.stopPropagation();
            if (itinerary[dayNum]) {
                itinerary[dayNum] = itinerary[dayNum].filter(id => id !== destId);
                saveItinerary();
                renderDayDestinations(dayNum);
                updateBudget();
                updateDaySlotStyle(dayNum);
            }
        }

        function updateDaySlotStyle(dayNum) {
            const slot = document.querySelector(`[data-day="${dayNum}"]`);
            if (!slot) return;
            const hasDests = itinerary[dayNum] && itinerary[dayNum].length > 0;
            slot.classList.toggle('day-slot-empty', !hasDests);
            slot.classList.toggle('day-slot-filled', hasDests);
        }

        function renderDayDestinations(dayNum) {
            const container = document.getElementById(`day-${dayNum}-destinations`);
            if (!container) return;

            const dayDests = itinerary[dayNum] || [];
            let html = '';

            if (dayDests.length === 0) {
                html = '<p class="text-xs text-slate-400 text-center py-2">Drop here</p>';
            } else {
                const allDests = getAllDestinations();
                dayDests.forEach(destId => {
                    const dest = allDests.find(d => d.id === destId);
                    if (dest) {
                        const colors = { thailand: 'amber', cambodia: 'rose', taiwan: 'emerald' };
                        const color = dest.isCustom ? 'indigo' : colors[dest.country];
                        html += `
                            <div class="flex items-center gap-2 bg-${color}-50 rounded-lg px-2 py-1.5 text-xs group">
                                <span class="w-1.5 h-1.5 rounded-full bg-${color}-500 flex-shrink-0"></span>
                                <span class="flex-1 truncate font-medium text-slate-700">${dest.name}</span>
                                <button onclick="removeFromDay('${destId}', ${dayNum}, event)"
                                        class="opacity-0 group-hover:opacity-100 text-slate-400 hover:text-red-500 transition-opacity">
                                    <i class="fas fa-times text-[10px]"></i>
                                </button>
                            </div>`;
                    }
                });
            }
            container.innerHTML = html;
        }

        function loadItinerary() {
            for (let i = 1; i <= 20; i++) {
                renderDayDestinations(i);
                updateDaySlotStyle(i);
            }
        }

        function saveItinerary() {
            localStorage.setItem('asiaItinerary', JSON.stringify(itinerary));
            syncItinerary(); // Sync to Firebase if collaborating
        }

        function clearItinerary() {
            if (confirm('Clear all planned destinations?')) {
                itinerary = {};
                saveItinerary();
                loadItinerary();
                updateBudget();
            }
        }

        // Budget calculation
        function updateBudget() {
            let thailandDays = 0, cambodiaDays = 0, taiwanDays = 0;
            let activityCosts = 0;

            Object.values(itinerary).forEach(dayDests => {
                dayDests.forEach(destId => {
                    const dest = destinations.find(d => d.id === destId);
                    if (dest) activityCosts += dest.cost;
                });
            });

            for (let i = 1; i <= 20; i++) {
                const dayDests = itinerary[i] || [];
                if (dayDests.length > 0) {
                    const dest = destinations.find(d => d.id === dayDests[0]);
                    if (dest) {
                        if (dest.country === 'thailand') thailandDays++;
                        else if (dest.country === 'cambodia') cambodiaDays++;
                        else if (dest.country === 'taiwan') taiwanDays++;
                    }
                }
            }

            const thailandCost = thailandDays * 110;
            const cambodiaCost = cambodiaDays * 100;
            const taiwanCost = taiwanDays * 150;
            const total = thailandCost + cambodiaCost + taiwanCost + activityCosts;

            document.getElementById('budget-thailand').textContent = `$${thailandCost}`;
            document.getElementById('budget-cambodia').textContent = `$${cambodiaCost}`;
            document.getElementById('budget-taiwan').textContent = `$${taiwanCost}`;
            document.getElementById('budget-total').textContent = `$${total}`;
            document.getElementById('budget-header').textContent = `$${total}`;
        }

        // Filter destinations
        function filterDestinations(query) {
            const cards = document.querySelectorAll('#destination-list .dest-card');
            const q = query.toLowerCase();
            cards.forEach(card => {
                card.style.display = card.textContent.toLowerCase().includes(q) ? '' : 'none';
            });
        }

        function filterDestinationsFull(query) {
            applyAllFilters();
        }

        function filterByCountry(country) {
            currentCountryFilter = country;
            updateFilterButton('.country-filter', 'country', country, 'bg-slate-100', 'text-slate-700');
            applyAllFilters();
        }

        function toggleDuration(duration) {
            currentDurationFilter = duration;
            updateFilterButton('.duration-filter', 'duration', duration, 'bg-sky-100', 'text-sky-700');
            applyAllFilters();
        }

        function toggleCost(cost) {
            currentCostFilter = cost;
            updateFilterButton('.cost-filter', 'cost', cost, 'bg-emerald-100', 'text-emerald-700');
            applyAllFilters();
        }

        function toggleCrowds(crowds) {
            currentCrowdsFilter = crowds;
            updateFilterButton('.crowds-filter', 'crowds', crowds, 'bg-amber-100', 'text-amber-700');
            applyAllFilters();
        }

        function updateFilterButton(selector, dataAttr, value, bgClass, textClass) {
            document.querySelectorAll(selector).forEach(btn => {
                if (btn.dataset[dataAttr] === value) {
                    btn.classList.add(bgClass, textClass);
                    btn.classList.remove('text-slate-500');
                } else {
                    btn.classList.remove(bgClass, textClass);
                    btn.classList.add('text-slate-500');
                }
            });
        }

        function clearAllFilters() {
            currentCountryFilter = 'all';
            currentDurationFilter = 'all';
            currentCostFilter = 'all';
            currentCrowdsFilter = 'all';
            document.getElementById('dest-search-full').value = '';

            updateFilterButton('.country-filter', 'country', 'all', 'bg-slate-100', 'text-slate-700');
            updateFilterButton('.duration-filter', 'duration', 'all', 'bg-sky-100', 'text-sky-700');
            updateFilterButton('.cost-filter', 'cost', 'all', 'bg-emerald-100', 'text-emerald-700');
            updateFilterButton('.crowds-filter', 'crowds', 'all', 'bg-amber-100', 'text-amber-700');
            applyAllFilters();
        }

        function applyAllFilters() {
            const query = document.getElementById('dest-search-full')?.value?.toLowerCase() || '';
            const cards = document.querySelectorAll('#destinations-grid .card');
            const allDests = getAllDestinations();
            let visibleCount = 0;

            cards.forEach(card => {
                const destId = card.getAttribute('onclick')?.match(/'([^']+)'/)?.[1];
                const dest = allDests.find(d => d.id === destId);
                if (!dest) return;

                // Search match
                const matchesSearch = query === '' || card.textContent.toLowerCase().includes(query);

                // Country match
                let matchesCountry = currentCountryFilter === 'all' || dest.country === currentCountryFilter;
                if (currentCountryFilter === 'custom') matchesCountry = dest.isCustom === true;

                // Duration match
                let matchesDuration = true;
                if (currentDurationFilter !== 'all') {
                    const days = dest.days;
                    if (currentDurationFilter === 'quick') matchesDuration = days <= 0.25;
                    else if (currentDurationFilter === 'half') matchesDuration = days > 0.25 && days <= 0.5;
                    else if (currentDurationFilter === 'full') matchesDuration = days > 0.5 && days <= 1;
                    else if (currentDurationFilter === 'multi') matchesDuration = days > 1;
                }

                // Cost match
                let matchesCost = true;
                if (currentCostFilter !== 'all') {
                    const cost = dest.cost;
                    if (currentCostFilter === 'free') matchesCost = cost === 0;
                    else if (currentCostFilter === 'budget') matchesCost = cost > 0 && cost <= 25;
                    else if (currentCostFilter === 'mid') matchesCost = cost > 25 && cost <= 75;
                    else if (currentCostFilter === 'premium') matchesCost = cost > 75;
                }

                // Crowds match
                let matchesCrowds = true;
                if (currentCrowdsFilter !== 'all') {
                    const crowds = dest.crowds?.toUpperCase();
                    if (currentCrowdsFilter === 'low') matchesCrowds = crowds === 'LOW';
                    else if (currentCrowdsFilter === 'moderate') matchesCrowds = crowds === 'MODERATE';
                    else if (currentCrowdsFilter === 'high') matchesCrowds = crowds === 'HIGH' || crowds === 'VERY HIGH';
                }

                const isVisible = matchesSearch && matchesCountry && matchesDuration && matchesCost && matchesCrowds;
                card.style.display = isVisible ? '' : 'none';
                if (isVisible) visibleCount++;
            });

            // Update filter summary
            const summary = document.getElementById('filter-summary');
            const hasActiveFilters = currentCountryFilter !== 'all' || currentDurationFilter !== 'all' ||
                                     currentCostFilter !== 'all' || currentCrowdsFilter !== 'all' || query !== '';
            if (hasActiveFilters) {
                summary.classList.remove('hidden');
                document.getElementById('visible-count').textContent = visibleCount;
                document.getElementById('total-count').textContent = allDests.length;
            } else {
                summary.classList.add('hidden');
            }
        }

        // Load templates
        function loadTemplate(template) {
            itinerary = {};

            if (template === 'thailand') {
                itinerary = {
                    1: ['wat-pho', 'grand-palace'], 2: ['chinatown', 'jodd-fairs'],
                    3: ['chatuchak', 'bkk-massage'], 4: ['doi-suthep', 'cm-old-city'],
                    5: ['khao-soi', 'night-bazaar'], 6: ['elephant-sanctuary'],
                    7: ['cooking-class', 'lantern-festival'], 8: [],
                    9: ['koh-tao-scuba'], 10: ['koh-tao-scuba'],
                    11: ['koh-tao-scuba'], 12: ['koh-tao-scuba'],
                    13: ['big-buddha'], 14: ['railay'],
                    15: ['rock-climbing', 'phra-nang'], 16: ['island-hopping'],
                    17: ['khao-sok'], 18: ['khao-sok'],
                    19: ['phuket-old'], 20: []
                };
            } else if (template === 'thailand-cambodia') {
                itinerary = {
                    1: ['wat-pho', 'grand-palace'], 2: ['chinatown'],
                    3: ['angkor-wat'], 4: ['angkor-wat', 'ta-prohm'],
                    5: ['bayon', 'apsara'], 6: ['doi-suthep', 'cm-old-city'],
                    7: ['elephant-sanctuary'], 8: ['cooking-class', 'lantern-festival'],
                    9: [], 10: ['koh-tao-scuba'],
                    11: ['koh-tao-scuba'], 12: ['koh-tao-scuba'],
                    13: ['koh-tao-scuba'], 14: ['big-buddha'],
                    15: ['railay', 'rock-climbing'], 16: ['island-hopping'],
                    17: ['phra-nang'], 18: ['chatuchak'],
                    19: ['bkk-massage', 'sky-bar'], 20: []
                };
            } else if (template === 'all') {
                itinerary = {
                    1: ['wat-pho', 'chinatown'], 2: ['grand-palace'],
                    3: ['angkor-wat'], 4: ['angkor-wat', 'ta-prohm'],
                    5: [], 6: ['koh-tao-scuba'],
                    7: ['koh-tao-scuba'], 8: ['koh-tao-scuba'],
                    9: ['koh-tao-scuba'], 10: ['railay'],
                    11: ['rock-climbing', 'island-hopping'], 12: ['doi-suthep'],
                    13: ['cooking-class', 'lantern-festival'], 14: [],
                    15: ['jiufen', 'beitou'], 16: ['sun-moon-lake'],
                    17: ['alishan'], 18: ['taichung-theater'],
                    19: [], 20: []
                };
            }

            saveItinerary();
            loadItinerary();
            updateBudget();
        }

        // Destination detail modal
        function showDestinationDetail(destId) {
            const allDests = getAllDestinations();
            const dest = allDests.find(d => d.id === destId);
            if (!dest) return;

            const colors = { thailand: 'amber', cambodia: 'rose', taiwan: 'emerald', custom: 'indigo' };
            const c = dest.isCustom ? 'indigo' : colors[dest.country];
            const modal = document.getElementById('modal');
            const content = document.getElementById('modal-content');

            const customButtons = dest.isCustom ? `
                <div class="flex gap-2 mb-4">
                    <button onclick="showCreateCustomModal('${dest.id}')" class="flex-1 flex items-center justify-center gap-2 px-3 py-2 rounded-lg bg-indigo-50 text-indigo-700 hover:bg-indigo-100 text-sm font-medium transition-colors">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button onclick="deleteCustomActivity('${dest.id}')" class="flex-1 flex items-center justify-center gap-2 px-3 py-2 rounded-lg bg-red-50 text-red-600 hover:bg-red-100 text-sm font-medium transition-colors">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            ` : '';

            content.innerHTML = `
                <div class="flex items-start justify-between mb-4">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            ${dest.isCustom ? '<span class="custom-badge">Custom</span>' : `<span class="badge-${dest.country} text-xs px-2 py-1 rounded-lg font-medium">${dest.country}</span>`}
                            <span class="text-xs text-slate-500">${dest.region}</span>
                        </div>
                        <h2 class="text-xl font-bold text-slate-800">${dest.name}</h2>
                    </div>
                    <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 hover:text-slate-600 hover:bg-slate-200 transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                ${customButtons}

                ${dest.closed ? '<div class="bg-red-100 border border-red-200 rounded-xl p-3 mb-4 text-sm text-red-700"><i class="fas fa-exclamation-triangle mr-2"></i><strong>Currently Closed</strong> - Not recommended for this trip</div>' : ''}

                <p class="text-slate-600 mb-5">${dest.desc}</p>

                <div class="grid grid-cols-3 gap-3 mb-5">
                    <div class="bg-slate-50 rounded-xl p-3 text-center">
                        <div class="text-xl font-bold text-slate-800">${dest.days}</div>
                        <div class="text-xs text-slate-500">Days</div>
                    </div>
                    <div class="bg-slate-50 rounded-xl p-3 text-center">
                        <div class="text-xl font-bold text-emerald-600">$${dest.cost}</div>
                        <div class="text-xs text-slate-500">Est. Cost</div>
                    </div>
                    <div class="bg-slate-50 rounded-xl p-3 text-center">
                        <div class="text-sm font-bold text-amber-600">${dest.crowds}</div>
                        <div class="text-xs text-slate-500">Crowds</div>
                    </div>
                </div>

                <div class="bg-${dest.isCustom ? 'indigo' : 'amber'}-50 rounded-xl p-4 mb-5">
                    <div class="flex items-center gap-2 text-${dest.isCustom ? 'indigo' : 'amber'}-800 font-semibold text-sm mb-1">
                        <i class="fas fa-lightbulb"></i> Tips
                    </div>
                    <p class="text-sm text-${dest.isCustom ? 'indigo' : 'amber'}-700">${dest.tips}</p>
                </div>

                <div class="flex gap-3">
                    <select id="add-to-day-select" class="flex-1 bg-slate-50 border-0 rounded-xl px-4 py-3 text-sm font-medium focus:ring-2 focus:ring-sky-500">
                        ${tripDays.map(d => `<option value="${d.day}">Day ${d.day} - ${d.dateStr}${d.isNYE ? ' (NYE!)' : ''}</option>`).join('')}
                    </select>
                    <button onclick="addFromModal('${dest.id}')" class="btn-primary">
                        <i class="fas fa-plus mr-2"></i>Add
                    </button>
                </div>
            `;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function addFromModal(destId) {
            const dayNum = parseInt(document.getElementById('add-to-day-select').value);
            addToDay(destId, dayNum);
            closeModal();
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // NYE selection
        function selectNYE(location) {
            const names = { 'chiang-mai': 'Chiang Mai Lanterns', 'bangkok': 'Bangkok Rooftop', 'koh-tao': 'Koh Tao Beach' };
            alert(`Great choice! NYE location set to: ${names[location]}\n\nYour itinerary templates will reflect this.`);
        }

        // Close modal on background click
        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target.id === 'modal') closeModal();
        });

        // Touch support for drag
        let touchDragId = null;
        document.addEventListener('touchstart', (e) => {
            const card = e.target.closest('.dest-card');
            if (card) {
                touchDragId = card.getAttribute('ondragstart')?.match(/'([^']+)'/)?.[1];
            }
        }, { passive: true });

        document.addEventListener('touchend', (e) => {
            if (touchDragId) {
                const touch = e.changedTouches[0];
                const elem = document.elementFromPoint(touch.clientX, touch.clientY);
                const daySlot = elem?.closest('.day-slot');
                if (daySlot) {
                    const dayNum = parseInt(daySlot.dataset.day);
                    addToDay(touchDragId, dayNum);
                }
                touchDragId = null;
            }
        }, { passive: true });

        // Custom Activity Modal Functions
        function showCreateCustomModal(editId = null) {
            const modal = document.getElementById('custom-modal');
            const form = document.getElementById('custom-form');
            const title = document.getElementById('custom-modal-title');

            if (editId) {
                const activity = customActivities.find(a => a.id === editId);
                if (activity) {
                    title.textContent = 'Edit Custom Activity';
                    form.dataset.editId = editId;
                    document.getElementById('custom-name').value = activity.name;
                    document.getElementById('custom-country').value = activity.country;
                    document.getElementById('custom-region').value = activity.region;
                    document.getElementById('custom-type').value = activity.type;
                    document.getElementById('custom-days').value = activity.days;
                    document.getElementById('custom-cost').value = activity.cost;
                    document.querySelector(`input[name="custom-crowds"][value="${activity.crowds}"]`).checked = true;
                    document.getElementById('custom-desc').value = activity.desc;
                    document.getElementById('custom-tips').value = activity.tips;
                    document.getElementById('custom-highlight').checked = activity.highlight || false;
                }
            } else {
                title.textContent = 'Create Custom Activity';
                form.reset();
                delete form.dataset.editId;
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeCustomModal() {
            const modal = document.getElementById('custom-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function saveCustomActivity(event) {
            event.preventDefault();
            const form = document.getElementById('custom-form');
            const editId = form.dataset.editId;

            const activityData = {
                id: editId || 'custom-' + Date.now(),
                name: document.getElementById('custom-name').value,
                country: document.getElementById('custom-country').value,
                region: document.getElementById('custom-region').value,
                type: document.getElementById('custom-type').value,
                days: parseFloat(document.getElementById('custom-days').value),
                cost: parseInt(document.getElementById('custom-cost').value) || 0,
                crowds: document.querySelector('input[name="custom-crowds"]:checked').value,
                desc: document.getElementById('custom-desc').value,
                tips: document.getElementById('custom-tips').value || 'Custom activity added by user',
                highlight: document.getElementById('custom-highlight').checked,
                isCustom: true
            };

            if (editId) {
                const index = customActivities.findIndex(a => a.id === editId);
                if (index !== -1) customActivities[index] = activityData;
            } else {
                customActivities.push(activityData);
            }

            localStorage.setItem('asiaCustomActivities', JSON.stringify(customActivities));
            syncCustomActivities(); // Sync to Firebase if collaborating
            closeCustomModal();
            renderDestinationList();
            if (currentTab === 'destinations') renderDestinationsGrid();
            updateDestCount();
        }

        function deleteCustomActivity(activityId) {
            if (!confirm('Delete this custom activity? This cannot be undone.')) return;

            customActivities = customActivities.filter(a => a.id !== activityId);
            localStorage.setItem('asiaCustomActivities', JSON.stringify(customActivities));
            syncCustomActivities(); // Sync to Firebase if collaborating

            // Remove from itinerary
            Object.keys(itinerary).forEach(day => {
                itinerary[day] = itinerary[day].filter(id => id !== activityId);
            });
            saveItinerary();

            closeModal();
            renderDestinationList();
            if (currentTab === 'destinations') renderDestinationsGrid();
            if (currentTab === 'planner') renderCalendar();
            updateDestCount();
        }

        // Close custom modal on background click
        document.getElementById('custom-modal').addEventListener('click', (e) => {
            if (e.target.id === 'custom-modal') closeCustomModal();
        });

        // ==========================================
        // COLLABORATION FUNCTIONS
        // ==========================================

        // Generate 6-character room code
        function generateRoomCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // Toast notification helper
        function showToast(message, type = 'info') {
            const colors = {
                success: 'bg-emerald-500',
                error: 'bg-red-500',
                warning: 'bg-amber-500',
                info: 'bg-sky-500'
            };

            const toast = document.createElement('div');
            toast.className = `fixed top-20 left-1/2 -translate-x-1/2 ${colors[type]} text-white px-6 py-3 rounded-xl shadow-lg z-[70] transition-opacity duration-300`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Initialize Firebase Auth
        async function initializeAuth() {
            return new Promise((resolve) => {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        currentUser = user;
                        console.log('Signed in as:', user.displayName || user.uid);

                        // Check URL for room code
                        const urlParams = new URLSearchParams(window.location.search);
                        const roomFromUrl = urlParams.get('room');
                        if (roomFromUrl) {
                            await joinRoom(roomFromUrl.toUpperCase(), user.displayName || 'Guest');
                        }
                        resolve(user);
                    } else {
                        // Check if there's a room in URL - if so, prompt sign in
                        const urlParams = new URLSearchParams(window.location.search);
                        const roomFromUrl = urlParams.get('room');
                        if (roomFromUrl) {
                            showToast('Sign in with Google to join the room', 'info');
                            setTimeout(() => signInWithGoogle(), 1000);
                        }
                        resolve(null);
                    }
                });
            });
        }

        // Sign in with Google
        async function signInWithGoogle() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await auth.signInWithPopup(provider);
                currentUser = result.user;
                showToast(`Welcome, ${currentUser.displayName}!`, 'success');
                return currentUser;
            } catch (error) {
                console.error('Google sign-in error:', error);
                if (error.code === 'auth/popup-closed-by-user') {
                    showToast('Sign-in cancelled', 'warning');
                } else {
                    showToast('Sign-in failed. Try again.', 'error');
                }
                return null;
            }
        }

        // Sign out
        async function signOut() {
            await auth.signOut();
            currentUser = null;
            await stopCollaboration();
            showToast('Signed out', 'info');
            updateCollaborationUI();
        }

        // Set up presence tracking
        function setupPresence() {
            if (!currentUser || !currentRoomCode) return;

            const memberRef = database.ref(`rooms/${currentRoomCode}/members/${currentUser.uid}`);
            const connectedRef = database.ref('.info/connected');

            connectedRef.on('value', (snap) => {
                if (snap.val() === true && currentRoomCode) {
                    memberRef.update({
                        online: true,
                        lastSeen: firebase.database.ServerValue.TIMESTAMP
                    });

                    memberRef.onDisconnect().update({
                        online: false,
                        lastSeen: firebase.database.ServerValue.TIMESTAMP
                    });
                }
            });
        }

        // Create a new room
        async function createRoom() {
            if (!currentUser) {
                const user = await signInWithGoogle();
                if (!user) return null;
            }

            const userName = currentUser.displayName || 'Guest';
            const roomCode = generateRoomCode();
            const newRoomRef = database.ref(`rooms/${roomCode}`);

            // Check if code already exists
            const snapshot = await newRoomRef.once('value');
            if (snapshot.exists()) {
                return createRoom();
            }

            // Create room with current data
            await newRoomRef.set({
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                createdBy: currentUser.uid,
                lastUpdated: firebase.database.ServerValue.TIMESTAMP,
                members: {
                    [currentUser.uid]: {
                        name: userName,
                        photoURL: currentUser.photoURL || null,
                        joinedAt: firebase.database.ServerValue.TIMESTAMP,
                        lastSeen: firebase.database.ServerValue.TIMESTAMP,
                        online: true
                    }
                },
                itinerary: itinerary,
                customActivities: customActivities
            });

            currentRoomCode = roomCode;
            startCollaboration();
            updateCollaborationUI();

            // Update URL
            const url = new URL(window.location);
            url.searchParams.set('room', roomCode);
            window.history.pushState({}, '', url);

            showToast(`Room created! Code: ${roomCode}`, 'success');
            return roomCode;
        }

        // Join an existing room
        async function joinRoom(roomCode, userName = null) {
            if (!currentUser) {
                const user = await signInWithGoogle();
                if (!user) return false;
            }

            userName = userName || currentUser.displayName || 'Guest';
            roomCode = roomCode.toUpperCase().trim();
            const joinRoomRef = database.ref(`rooms/${roomCode}`);

            // Check if room exists
            const snapshot = await joinRoomRef.once('value');
            if (!snapshot.exists()) {
                showToast('Room not found. Check the code.', 'error');
                return false;
            }

            // Add self to members
            await joinRoomRef.child(`members/${currentUser.uid}`).set({
                name: userName,
                photoURL: currentUser.photoURL || null,
                joinedAt: firebase.database.ServerValue.TIMESTAMP,
                lastSeen: firebase.database.ServerValue.TIMESTAMP,
                online: true
            });

            currentRoomCode = roomCode;

            // Load room data
            const roomData = snapshot.val();
            itinerary = roomData.itinerary || {};
            customActivities = roomData.customActivities || [];

            // Save to localStorage as backup
            localStorage.setItem('asiaItinerary', JSON.stringify(itinerary));
            localStorage.setItem('asiaCustomActivities', JSON.stringify(customActivities));

            // Refresh UI
            renderDestinationList();
            renderCalendar();
            if (currentTab === 'destinations') renderDestinationsGrid();
            updateBudget();
            updateDestCount();

            startCollaboration();
            updateCollaborationUI();

            // Update URL
            const url = new URL(window.location);
            url.searchParams.set('room', roomCode);
            window.history.pushState({}, '', url);

            showToast(`Joined room ${roomCode}!`, 'success');
            return true;
        }

        // Start real-time collaboration
        function startCollaboration() {
            if (!currentRoomCode) return;

            isCollaborating = true;
            roomRef = database.ref(`rooms/${currentRoomCode}`);

            // Listen for itinerary changes
            itineraryListener = roomRef.child('itinerary').on('value', (snapshot) => {
                // Skip initial fire (we already loaded data in joinRoom)
                // and skip if we're the one who just synced (prevents echo)
                if (isInitialLoad || isSyncingItinerary) {
                    console.log('Skipping itinerary update (initial or self-sync)');
                    return;
                }

                const remoteItinerary = snapshot.val() || {};

                if (JSON.stringify(remoteItinerary) !== JSON.stringify(itinerary)) {
                    console.log('Received remote itinerary update from collaborator');
                    itinerary = remoteItinerary;
                    localStorage.setItem('asiaItinerary', JSON.stringify(itinerary));
                    renderCalendar();
                    updateBudget();
                    showToast('Itinerary updated by collaborator', 'info');
                }
            });

            // Listen for custom activities changes
            customActivitiesListener = roomRef.child('customActivities').on('value', (snapshot) => {
                // Skip initial fire and self-syncs
                if (isInitialLoad || isSyncingCustom) {
                    console.log('Skipping custom activities update (initial or self-sync)');
                    return;
                }

                const remoteCustom = snapshot.val() || [];

                if (JSON.stringify(remoteCustom) !== JSON.stringify(customActivities)) {
                    console.log('Received remote custom activities update from collaborator');
                    customActivities = remoteCustom;
                    localStorage.setItem('asiaCustomActivities', JSON.stringify(customActivities));
                    renderDestinationList();
                    if (currentTab === 'destinations') renderDestinationsGrid();
                    updateDestCount();
                }
            });

            // Clear initial load flag after listeners have fired once
            setTimeout(() => {
                isInitialLoad = false;
                console.log('Initial load complete, now listening for collaborator updates');
            }, 1000);

            // Listen for member changes
            membersListener = roomRef.child('members').on('value', (snapshot) => {
                const members = snapshot.val() || {};
                updateMembersUI(members);
            });

            setupPresence();
        }

        // Stop collaboration
        function stopCollaboration() {
            if (roomRef) {
                if (itineraryListener) roomRef.child('itinerary').off('value', itineraryListener);
                if (customActivitiesListener) roomRef.child('customActivities').off('value', customActivitiesListener);
                if (membersListener) roomRef.child('members').off('value', membersListener);
            }

            isCollaborating = false;
            currentRoomCode = null;
            roomRef = null;
            isInitialLoad = true; // Reset for next join

            const url = new URL(window.location);
            url.searchParams.delete('room');
            window.history.pushState({}, '', url);

            updateCollaborationUI();
        }

        // Sync itinerary to Firebase
        function syncItinerary() {
            if (isCollaborating && roomRef) {
                isSyncingItinerary = true;
                roomRef.child('itinerary').set(itinerary)
                    .then(() => {
                        roomRef.child('lastUpdated').set(firebase.database.ServerValue.TIMESTAMP);
                        // Clear flag after a short delay to ignore our own echo
                        setTimeout(() => { isSyncingItinerary = false; }, 500);
                    })
                    .catch((error) => {
                        console.error('Sync error:', error);
                        showToast('Sync failed. Changes saved locally.', 'warning');
                        isSyncingItinerary = false;
                    });
            }
        }

        // Sync custom activities to Firebase
        function syncCustomActivities() {
            if (isCollaborating && roomRef) {
                isSyncingCustom = true;
                roomRef.child('customActivities').set(customActivities)
                    .then(() => {
                        roomRef.child('lastUpdated').set(firebase.database.ServerValue.TIMESTAMP);
                        setTimeout(() => { isSyncingCustom = false; }, 500);
                    })
                    .catch((error) => {
                        console.error('Sync error:', error);
                        isSyncingCustom = false;
                    });
            }
        }

        // UI Functions
        function showCollabModal() {
            const modal = document.getElementById('collab-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            updateUserDisplay();
            updateCollaborationUI();
        }

        function closeCollabModal() {
            const modal = document.getElementById('collab-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function updateCollaborationUI() {
            const statusEl = document.getElementById('collab-status');
            const startEl = document.getElementById('collab-start');
            const activeEl = document.getElementById('collab-active');
            const roomCodeEl = document.getElementById('collab-room-code');
            const activeCodeEl = document.getElementById('active-room-code');

            // Update user display in modal
            updateUserDisplay();

            if (isCollaborating && currentRoomCode) {
                statusEl?.classList.remove('hidden');
                if (roomCodeEl) roomCodeEl.textContent = `Room: ${currentRoomCode}`;
                if (activeCodeEl) activeCodeEl.textContent = currentRoomCode;
                startEl?.classList.add('hidden');
                activeEl?.classList.remove('hidden');
            } else {
                statusEl?.classList.add('hidden');
                startEl?.classList.remove('hidden');
                activeEl?.classList.add('hidden');
            }
        }

        function updateUserDisplay() {
            const avatarEl = document.getElementById('user-avatar');
            const nameEl = document.getElementById('user-name');
            const emailEl = document.getElementById('user-email');
            const signInBtn = document.getElementById('sign-in-btn');
            const signOutBtn = document.getElementById('sign-out-btn');

            if (currentUser) {
                if (currentUser.photoURL) {
                    avatarEl.innerHTML = `<img src="${currentUser.photoURL}" class="w-10 h-10 rounded-full">`;
                } else {
                    avatarEl.innerHTML = `<i class="fas fa-user"></i>`;
                }
                nameEl.textContent = currentUser.displayName || 'Guest';
                emailEl.textContent = currentUser.email || '';
                signInBtn?.classList.add('hidden');
                signOutBtn?.classList.remove('hidden');
            } else {
                avatarEl.innerHTML = `<i class="fas fa-user"></i>`;
                nameEl.textContent = 'Not signed in';
                emailEl.textContent = '';
                signInBtn?.classList.remove('hidden');
                signOutBtn?.classList.add('hidden');
            }
        }

        function updateMembersUI(members) {
            const list = document.getElementById('members-list');
            if (!list) return;

            let html = '';
            Object.entries(members).forEach(([uid, member]) => {
                const isYou = uid === currentUser?.uid;
                const onlineClass = member.online ? 'bg-emerald-500' : 'bg-slate-300';
                const photoHtml = member.photoURL
                    ? `<img src="${member.photoURL}" class="w-6 h-6 rounded-full">`
                    : `<span class="w-6 h-6 rounded-full bg-slate-200 flex items-center justify-center text-slate-500 text-xs"><i class="fas fa-user"></i></span>`;

                html += `
                    <div class="flex items-center gap-3 p-2 rounded-lg ${isYou ? 'bg-purple-100' : ''}">
                        <span class="w-2 h-2 rounded-full ${onlineClass}"></span>
                        ${photoHtml}
                        <span class="flex-1 font-medium text-slate-700">${member.name}</span>
                        ${isYou ? '<span class="text-xs text-purple-600">(You)</span>' : ''}
                    </div>
                `;
            });

            list.innerHTML = html;
        }

        async function handleCreateRoom() {
            const roomCode = await createRoom();
            if (roomCode) {
                closeCollabModal();
            }
        }

        async function handleJoinRoom() {
            const code = document.getElementById('join-code')?.value;
            if (!code || code.length !== 6) {
                showToast('Enter a valid 6-character code', 'error');
                return;
            }
            const success = await joinRoom(code);
            if (success) closeCollabModal();
        }

        function copyRoomLink() {
            const url = `${window.location.origin}${window.location.pathname}?room=${currentRoomCode}`;
            navigator.clipboard.writeText(url);
            showToast('Link copied!', 'success');
        }

        function leaveRoom() {
            if (confirm('Leave room? Your data stays saved locally.')) {
                // Mark as offline before leaving
                if (currentUser && currentRoomCode) {
                    database.ref(`rooms/${currentRoomCode}/members/${currentUser.uid}`).update({
                        online: false
                    });
                }
                stopCollaboration();
                closeCollabModal();
                showToast('Left the room.', 'info');
            }
        }

        // Close collab modal on background click
        document.getElementById('collab-modal')?.addEventListener('click', (e) => {
            if (e.target.id === 'collab-modal') closeCollabModal();
        });

        // Initialize Firebase auth on page load
        initializeAuth();
    </script>
</body>
</html>
